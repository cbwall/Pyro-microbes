---
title: "Pyromania part 3"
author: "C Wall"
date: "9/13/2023"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options: 
  chunk_output_type: console
---

## Project overview
The goal of the *Pyromania project* is to test how terrestrial subsides (plant biomass loading or "browning") and burning influence aquatic productivity, water quality/chemistry, and trophic transfer. We used a manipulative experiment to assess a range of plant material quantities (0-400g per tank) and fire treatment (burned vs unburned material) and the non-linearity of these effects on aquatic systems through 4 time-point samplings. We used 400L aquatic mesocosms and ran the experiment for ~90d in 2021-2022.  

<center>  
  
![**Figure**. Images showing (**A**) controlled burning of plant material, (**B**) dried unburned plants and (**C**) packed plant material in mesh bags, (**D**) visual differences in water quality between tanks receiving high (left) and low (right) amounts of plant detritus, and (E) the experimental mesocosm array at the University of San Diego Biological Field Station.](output/Cody_tanks.jpg){width=80%}
  
</center>  

**DATA SETS**  
This data set is among 3 to be generated for the project and focuses on:  

(1) **microbes (16S rRNA) communities** over time and in 'reservoirs'
- water-borne microbes through time
- associated with plant detritus (terminal sampling)
- host-associated (zooplankton and insect [mosquito] larvae, terminal sampling)
(2) **microbial cell abundance**, assessed through flow cytometry of autotrophic and heterotrophic cells
(3) **zooplankton community**, primarily Daphniidae (cladocerans), copepods, and mosquitoes
(4) **Î´^13^C of greenhouse gases** carbon dioxide (CO~2~), methane (CH~4~)
  
   
**TIME POINTS**  

* Time-0 (**T0**) = before the addition of plant materials, plankton were stocked at this stage  
* Time-1 (**T1**) = 10 days after the addition of plant materials  
* Time-2 (**T2**) = 31 days after ...  
* Time-3 (**T3**) = 59 days after ...  
* Time-4 (**T4**) = 89 days after ... 
* Time-5 (**T5**) = 124 days after ...

```{r setup chunk, setup, include = FALSE, cache=FALSE, message=FALSE, warning=FALSE}
if (!require('knitr')) install.packages('knitr'); library('knitr')
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center')

# load packages
if (!require("pacman")) install.packages("pacman") # for rapid install if not in library

# use pacman to load all the packages you are missing!
pacman::p_load('knitr', 'lme4', 'lmerTest', 'tidyverse', 'magrittr', 'effects', 'plyr', 'dplyr', 'plotrix', 'car',"gridExtra", "cowplot", "tools", "mgcv", "gratia", "MASS", "stats", "tidymv", "sjstats", "coin", "emmeans", "doBy", "forcats", "ggplot2", "SiZer")

Fig.formatting<-(theme_classic()) +
  theme(text=element_text(size=10),
        axis.line=element_blank(),
        legend.text.align = 0,
        legend.text=element_text(size=10),
        #legend.title = element_blank(),
        panel.border = element_rect(fill=NA, colour = "black", size=1),
        aspect.ratio=1, 
        axis.ticks.length=unit(0.25, "cm"),
        axis.text.y=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=10), 
        axis.text.x=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=8)) +
  theme(legend.key.size = unit(0.4, "cm")) +
  theme(aspect.ratio=1.3) +
  theme(panel.spacing=unit(c(0, 0, 0, 0), "cm"))

```

### Flow Cytometry 
Flow Cytometry data here is used to determine the abundance of autotrophic (primary producers, photosynthesizers) and heterotrophic (no photopigments) bacterial cells. 
```{r, FCM}
fcm.df<-read.csv("data/Pyro_fcm.csv")

cols<-c("Time.point", "Tank", "Treatment")
fcm.df[cols] <- lapply(fcm.df[cols], factor) # make all these factors
```

Do autofluorescence for autotrophic bacteria
```{r FCM AF, results='hide', fig.show='hide'}
### Time 1
######## T1 model
m1.AF.T1<-gam(af_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = fcm.df, method = "REML")

m2.AF.T1<-gam(af_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = fcm.df, method = "REML")

m3.AF.T1<-gam(af_sum ~  s(plant.mass..g), subset = Time.point=="T1", data = fcm.df, method = "REML")

T1.AF.AIC<-AIC(m1.AF.T1, m2.AF.T1, m3.AF.T1)
# best is smoother solo

summary(m3.AF.T1)
anova.gam(m3.AF.T1)
gam.check(m3.AF.T1, rep=1000)
draw(m3.AF.T1)
concrvity(m3.AF.T1)
par(mfrow = c(2, 2))
plot(m3.AF.T1, all.terms = TRUE, page=1)

# model predictions
AF.diff.T1<-plot_difference(
  m1.AF.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
AF.T1.mod.plot<-
  plot_smooths(
  model = m3.AF.T1,
  series = plant.mass..g,
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=af_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 4000000)) +
  ggtitle("Day-10") +
  ylab("AF sum") +
  xlab("plant material (g)") +
  Fig.formatting


### Time 3
######## T3 model
m1.AF.T3<-gam(af_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = fcm.df, method = "REML")

m2.AF.T3<-gam(af_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = fcm.df, method = "REML")

m3.AF.T3<-gam(af_sum ~  s(plant.mass..g), subset = Time.point=="T3", data = fcm.df, method = "REML")

T3.AF.AIC<-AIC(m1.AF.T3, m2.AF.T3, m3.AF.T3)
# best is smoother solo

summary(m3.AF.T3)
anova.gam(m3.AF.T3)
gam.check(m3.AF.T3, rep=1000)
draw(m3.AF.T3)
concrvity(m3.AF.T3)
par(mfrow = c(2, 2))
plot(m3.AF.T3, all.terms = TRUE, page=1)

# model predictions
AF.diff.T3<-plot_difference(
  m1.AF.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
AF.T3.mod.plot<-
  plot_smooths(
  model = m3.AF.T3,
  series = plant.mass..g,
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=af_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 4000000)) +
  ggtitle("Day-59") +
  ylab("AF sum") +
  xlab("plant material (g)") +
  Fig.formatting


### Time 4
######## T4 model
m1.AF.T4<-gam(af_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = fcm.df, method = "REML")

m2.AF.T4<-gam(af_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = fcm.df, method = "REML")

m3.AF.T4<-gam(af_sum ~  s(plant.mass..g), subset = Time.point=="T4", data = fcm.df, method = "REML")

T4.AF.AIC<-AIC(m1.AF.T4, m2.AF.T4, m3.AF.T4)
# best is smoother solo

summary(m1.AF.T4)
anova.gam(m1.AF.T4)
gam.check(m1.AF.T4, rep=1000)
draw(m1.AF.T4)
concrvity(m1.AF.T4)
par(mfrow = c(2, 2))
plot(m1.AF.T4, all.terms = TRUE, page=1)

# model predictions
AF.diff.T4<-plot_difference(
  m1.AF.T4,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
AF.T4.mod.plot<-
  plot_smooths(
  model = m1.AF.T4,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=af_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 4000000)) +
  ggtitle("Day-89") +
  ylab("AF sum") +
  xlab("plant material (g)") +
  Fig.formatting

```

Now do syber green stained for 'all DNA' getting all bacterial community cells
```{r fcm sg, results='hide', fig.show='hide'}
### Time 1
######## T1 model
m1.SG.T1<-gam(sg_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = fcm.df, method = "REML")

m2.SG.T1<-gam(sg_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = fcm.df, method = "REML")

m3.SG.T1<-gam(sg_sum ~  s(plant.mass..g), subset = Time.point=="T1", data = fcm.df, method = "REML")

T1.SG.AIC<-AIC(m1.SG.T1, m2.SG.T1, m3.SG.T1)
# best is smoother solo

summary(m3.SG.T1)
anova.gam(m3.SG.T1)
gam.check(m3.SG.T1, rep=1000)
draw(m3.SG.T1)
concrvity(m3.SG.T1)
par(mfrow = c(2, 2))
plot(m3.SG.T1, all.terms = TRUE, page=1)

# model predictions
SG.diff.T1<-plot_difference(
  m1.SG.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
SG.T1.mod.plot<-
  plot_smooths(
  model = m3.SG.T1,
  series = plant.mass..g,
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=sg_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30000000)) +
  ggtitle("Day-10") +
  ylab("SG sum") +
  xlab("plant material (g)") +
  Fig.formatting


############## testing SiZer
x1 <- fcm.df[(fcm.df$Time.point=="T1"),]
x <- x1$plant.mass..g
y <- x1$sg_sum

plot(x,y)

# Calculate the SiZer map for the first derivative
SiZer.1 <- SiZer(x, y, h=c(50,100), degree=2, derv=2, grid.length=50)
plot(SiZer.1)
plot(SiZer.1, ggplot2=TRUE)
###########



### Time 3
######## T3 model
m1.SG.T3<-gam(sg_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = fcm.df, method = "REML")

m2.SG.T3<-gam(sg_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = fcm.df, method = "REML")

m3.SG.T3<-gam(sg_sum ~  s(plant.mass..g), subset = Time.point=="T3", data = fcm.df, method = "REML")

T3.SG.AIC<-AIC(m1.SG.T3, m2.SG.T3, m3.SG.T3)
# best is smoother solo

summary(m3.SG.T3)
anova.gam(m3.SG.T3)
gam.check(m3.SG.T3, rep=1000)
draw(m3.SG.T3)
concrvity(m3.SG.T3)
par(mfrow = c(2, 2))
plot(m3.SG.T3, all.terms = TRUE, page=1)

# model predictions
SG.diff.T3<-plot_difference(
  m1.SG.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
SG.T3.mod.plot<-
  plot_smooths(
  model = m3.SG.T3,
  series = plant.mass..g,
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=sg_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30000000)) +
  ggtitle("Day-59") +
  ylab("SG sum") +
  xlab("plant material (g)") +
  Fig.formatting


### Time 4
######## T4 model
m1.SG.T4<-gam(sg_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = fcm.df, method = "REML")

m2.SG.T4<-gam(sg_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = fcm.df, method = "REML")

m3.SG.T4<-gam(sg_sum ~  s(plant.mass..g), subset = Time.point=="T4", data = fcm.df, method = "REML")

T4.SG.AIC<-AIC(m1.SG.T4, m2.SG.T4, m3.SG.T4)
# best is smoother solo

summary(m1.SG.T4)
anova.gam(m1.SG.T4)
gam.check(m1.SG.T4, rep=1000)
draw(m1.SG.T4)
concrvity(m1.SG.T4)
par(mfrow = c(2, 2))
plot(m1.SG.T4, all.terms = TRUE, page=1)

# model predictions
SG.diff.T4<-plot_difference(
  m1.SG.T4,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
SG.T4.mod.plot<-
  plot_smooths(
  model = m1.SG.T4,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=sg_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30000000)) +
  ggtitle("Day-89") +
  ylab("SG sum") +
  xlab("plant material (g)") +
  Fig.formatting

```

Export model outputs and compile the figures for flow cytometry
```{r fcm comp figs}
#######################
## export model selection parameters
mod.rep<-rep(c("~Treatment + s(plant.mass..g, by= Treatment)", 
              "~Treatment + s(plant.mass..g)", 
              "~s(plant.mass..g)"), times=3)

mod.Fcm.df<- data.frame(mod.rep)

AIC.AF<-bind_rows(T1.AF.AIC, T3.AF.AIC, T4.AF.AIC, T1.SG.AIC, T3.SG.AIC, T4.SG.AIC)
AIC.Fcm.mod<-cbind(mod.Fcm.df, AIC.AF)

write.csv(AIC.Fcm.mod, "output/AIC models/AIC.Fcm.csv")

#######################
### make the figure

extract.legend <- get_legend(
  # create some space to the left of the legend
  SG.T4.mod.plot + theme(legend.box.margin = margin(0, 0, 0, 10)))


FCM.alltimes<-plot_grid(
  AF.T1.mod.plot+ theme(legend.position = "none"),
  AF.T3.mod.plot+ theme(legend.position = "none"),
  AF.T4.mod.plot+ theme(legend.position = "none"), extract.legend,
  SG.T1.mod.plot+ theme(legend.position = "none"),
  SG.T3.mod.plot+ theme(legend.position = "none"),
  SG.T4.mod.plot+ theme(legend.position = "none"), extract.legend,
  rel_widths = c(8,8,8,3, 8,8,8,3), ncol=4)
ggsave("figures/FCM.alltimes.mod.pdf", height=6, width=9)

FCM.alltimes



#### model fits
FCM.mod.dif<-plot_grid(
  #AF.diff.T1+ theme(legend.position = "none")+ ggtitle("AF Day-10"),
  #AF.diff.T3+ theme(legend.position = "none")+ ggtitle("AF-Day-59"),
  AF.diff.T4+ theme(legend.position = "none")+ ggtitle("AF-Day-89"),
  #SG.diff.T1+ theme(legend.position = "none")+ ggtitle("SG Day-10"),
  #SG.diff.T3+ theme(legend.position = "none")+ ggtitle("SG-Day-59"),
  SG.diff.T4+ theme(legend.position = "none")+ ggtitle("SG-Day-89"),
  ncol=1)
FCM.mod.dif
ggsave("figures/FCM.mod.diff.pdf", height=7, width=4)
```


### Zooplankton/Larvae Community. 
Counts of zooplankton to get density and community compositions. First, smith-it a bit to cleanup the data and organize for analysis. Models run for T1-T4.  
```{r zoop wrangle, results='hide', fig.show='hide'}
plank<-read.csv("data/zooplankton/Pyro_Master zoop data.csv")
names(plank)

plank<-  plyr::rename(plank, c("TANK" = "Tank", 
                               "DATE.COLLECTED" = "Date.collected",
                               "X.COUNTED"= "Number.counted", 
                               "COUNTED.ON"= "Count.date",
                               "COUNTED.BY" = "Counted.by", 
                               "SPECIES" = "Species",
                               "X..OF.INDIVIDUALS" = "Number.of.individ"))



vols<-read.csv("data/zooplankton/Pyro_plankton.volume.csv")
names(vols)<-c("Date.collected","Time.point","Treatment","plant.mass..g","Tank","Volume.sampled..mL")

# fixing dates
vols$Date.collected<-as.factor(as.POSIXct(vols$Date.collected, format="%m/%d/%Y"))
plank$Date.collected<-as.factor(as.POSIXct(plank$Date.collected, format="%m/%d/%y"))

# fixing dates that have wrong year
plank$Date.collected[plank$Date.collected=="2022-11-03"]<-"2021-11-03"
plank$Date.collected[plank$Date.collected=="2022-11-15"]<-"2021-11-15"
plank$Date.collected[plank$Date.collected=="2022-12-06"]<-"2021-12-06"

#drop levels
plank<-droplevels(plank)
#inspect table
table(plank$Date.collected, plank$Time.point)

zoop<-merge(plank, vols, by=c("Tank","Date.collected","Time.point"), all=T)
levels(as.factor(zoop$Date.collected))
summary(zoop)

table(zoop$Time.point, zoop$Tank)
table(zoop$Counted.by, zoop$Tank)

levels(as.factor(zoop$Species))

# rename species
zoop<-zoop %>%
  mutate(Species = fct_recode(`Species`,
                              "Daphnia"  = "Bursted Daphnia"))

levels(as.factor(zoop$Species))


zoop$spp <- casefold(zoop$Species, upper = FALSE)
levels(as.factor(zoop$spp))
str(zoop)

# calculate density
# originally as mL of volume samples, multiply by 1000 to get planton per liter
zoop$Density<-1000*zoop$Number.of.individ/zoop$Volume.sampled..mL

levels(as.factor(zoop$Date.collected))

table(zoop$Tank[zoop$Date.collected=="2021-11-03"], zoop$spp[zoop$Date.collected=="2021-11-03"])

# reorder columns and export
zoop<- zoop %>% dplyr::select(Time.point, Date.collected, Treatment, plant.mass..g, Tank, spp, Density)

write.csv(zoop, "data/zooplankton/Pyro_zoop_cleaned.csv")
#############################################

# make summary dataframe
z.mean.density<-summaryBy(Density ~ Tank + Date.collected + Time.point + Treatment + plant.mass..g +
               spp, data = zoop, FUN = mean)

# pivot to columns
zoop.all<-pivot_wider(z.mean.density, names_from="spp", values_from="Density.mean")
zoop.all[is.na(zoop.all)]<-0

zoop.all<-as.data.frame(zoop.all)
cols2<-c("Time.point", "Tank", "Date.collected", "Treatment")
zoop.all[cols2] <- lapply(zoop.all[cols2], factor) # make all these factors


```

#### Daphniidae density 
This is grouped *Daphnia*, as well as lesser abundant taxa *Ceriodaphnia*, *Bosmina*
```{r, Daphniidae}
######### Daphniidae

zoop.all$Daphniidae<-zoop.all$daphnia + zoop.all$ceriodaphnia + zoop.all$bosmina

######## T0 model
m1.daphniid.T0<-gam(Daphniidae~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T0", data = zoop.all, method = "REML")

m2.daphniid.T0<-gam(Daphniidae ~  Treatment + s(plant.mass..g), subset = Time.point=="T0", data = zoop.all, method = "REML")

m3.daphniid.T0<-gam(Daphniidae ~  s(plant.mass..g), subset = Time.point=="T0", data = zoop.all, method = "REML")

T0.daphniid.AIC<-AIC(m1.daphniid.T0, m2.daphniid.T0, m3.daphniid.T0)
# best is smoother solo

summary(m2.daphniid.T0)
anova.gam(m2.daphniid.T0)
gam.check(m2.daphniid.T0, rep=1000)
draw(m2.daphniid.T0)
concrvity(m2.daphniid.T0)
par(mfrow = c(2, 2))
plot(m2.daphniid.T0, all.terms = TRUE, page=1)

###########  
#plot for the model output on rawdata
daphniid.T0.mod.plot<-
  plot_smooths(
  model = m3.daphniid.T0,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T0"),], 
             aes(x=plant.mass..g, y=Daphniidae, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-0") +
  ylab("Daphniidae density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



######## T1 model
m1.daphniid.T1<-gam(Daphniidae~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.daphniid.T1<-gam(Daphniidae ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.daphniid.T1<-gam(Daphniidae ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.daphniid.AIC<-AIC(m1.daphniid.T1, m2.daphniid.T1, m3.daphniid.T1)
# best is smoother solo

summary(m3.daphniid.T1)
anova.gam(m3.daphniid.T1)
gam.check(m3.daphniid.T1, rep=1000)
draw(m3.daphniid.T1)
concrvity(m3.daphniid.T1)
par(mfrow = c(2, 2))
plot(m3.daphniid.T1, all.terms = TRUE, page=1)

###########  
#plot for the model output on rawdata
daphniid.T1.mod.plot<-
  plot_smooths(
  model = m3.daphniid.T1,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=Daphniidae, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-10") +
  ylab("Daphniidae density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T2 model
m1.daphniid.T2<-gam(Daphniidae~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = zoop.all, method = "REML")

m2.daphniid.T2<-gam(Daphniidae ~  Treatment + s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

m3.daphniid.T2<-gam(Daphniidae ~  s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

T2.daphniid.AIC<-AIC(m1.daphniid.T2, m2.daphniid.T2, m3.daphniid.T2)
# best is smoother solo

summary(m3.daphniid.T2)
anova.gam(m3.daphniid.T2)
gam.check(m3.daphniid.T2, rep=1000)
draw(m3.daphniid.T2)
concrvity(m3.daphniid.T2)
par(mfrow = c(2, 2))
plot(m3.daphniid.T2, all.terms = TRUE, page=1)


###########  
#plot for the model output on rawdata
daphniid.T2.mod.plot<-
  plot_smooths(
  model = m3.daphniid.T2,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=Daphniidae, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-31") +
  ylab("Daphniidae density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T3 model
m1.daphniid.T3<-gam(Daphniidae~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = zoop.all, method = "REML")

m2.daphniid.T3<-gam(Daphniidae ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

m3.daphniid.T3<-gam(Daphniidae ~  s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

T3.daphniid.AIC<-AIC(m1.daphniid.T3, m2.daphniid.T3, m3.daphniid.T3)
# best is smoother solo

summary(m1.daphniid.T3)
anova.gam(m1.daphniid.T3)
gam.check(m1.daphniid.T3, rep=1000)
draw(m1.daphniid.T3)
concrvity(m1.daphniid.T3)
par(mfrow = c(2, 2))
plot(m1.daphniid.T3, all.terms = TRUE, page=1)


# model predictions
daphniid.diff.T3<-plot_difference(
  m1.daphniid.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

daphniid.T3.diff.plot + ggtitle("Day-59 Daphniidae")
ggsave("figures/Daphniid.moddiff.T3.pdf", height=4, width=4)


###########  
#plot for the model output on rawdata
daphniid.T3.mod.plot<-
  plot_smooths(
  model = m1.daphniid.T3,
  series = plant.mass..g,
  comparison=Treatment,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=Daphniidae, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-59") +
  ylab("Daphniidae density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T4 model
m1.daphniid.T4<-gam(Daphniidae~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = zoop.all, method = "REML")

m2.daphniid.T4<-gam(Daphniidae ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

m3.daphniid.T4<-gam(Daphniidae ~  s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

T4.daphniid.AIC<-AIC(m1.daphniid.T4, m2.daphniid.T4, m3.daphniid.T4)
# best is smoother solo

summary(m3.daphniid.T4)
anova.gam(m3.daphniid.T4)
gam.check(m3.daphniid.T4, rep=1000)
draw(m3.daphniid.T4)
concrvity(m3.daphniid.T4)
par(mfrow = c(2, 2))
plot(m3.daphniid.T4, all.terms = TRUE, page=1)



###########  
#plot for the model output on rawdata
daphniid.T4.mod.plot<-
  plot_smooths(
  model = m3.daphniid.T4,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=Daphniidae, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-89") +
  ylab("Daphniidae density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

```

#### Copepoda 
*Copepods grouped* = calanoids, cyclopoids, nauplii
```{r, Copepods}
######### Copepods

zoop.all$Copepods<-zoop.all$calanoid + zoop.all$cyclopoid + zoop.all$nauplii


######## T0 model
m1.Copep.T0<-gam(Copepods~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T0", data = zoop.all, method = "REML")

m2.Copep.T0<-gam(Copepods ~  Treatment + s(plant.mass..g), subset = Time.point=="T0", data = zoop.all, method = "REML")

m3.Copep.T0<-gam(Copepods ~  s(plant.mass..g), subset = Time.point=="T0", data = zoop.all, method = "REML")

T0.Copep.AIC<-AIC(m1.Copep.T0, m2.Copep.T0, m3.Copep.T0)
# best is separate smoother

summary(m1.Copep.T0)
anova.gam(m1.Copep.T0)
gam.check(m1.Copep.T0, rep=1000)
draw(m1.Copep.T0)
concrvity(m1.Copep.T0)
par(mfrow = c(2, 2))
plot(m1.Copep.T0, all.terms = TRUE, page=1)

###########  
#plot for the model output on rawdata
Copep.T0.mod.plot<-
  plot_smooths(
  model = m1.Copep.T0,
  series = plant.mass..g,
  comparison=Treatment,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T0"),], 
             aes(x=plant.mass..g, y=Copepods, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30)) +
  ggtitle("Day-0") +
  ylab("Copepod density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



######## T1 model
m1.Copep.T1<-gam(Copepods~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.Copep.T1<-gam(Copepods ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.Copep.T1<-gam(Copepods ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.Copep.AIC<-AIC(m1.Copep.T1, m2.Copep.T1, m3.Copep.T1)
# best is smoother solo

summary(m3.Copep.T1)
anova.gam(m3.Copep.T1)
gam.check(m3.Copep.T1, rep=1000)
draw(m3.Copep.T1)
concrvity(m3.Copep.T1)
par(mfrow = c(2, 2))
plot(m3.Copep.T1, all.terms = TRUE, page=1)

###########  
#plot for the model output on rawdata
Copep.T1.mod.plot<-
  plot_smooths(
  model = m3.Copep.T1,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=Copepods, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30)) +
  ggtitle("Day-10") +
  ylab("Copepods density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T2 model
m1.Copep.T2<-gam(Copepods~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = zoop.all, method = "REML")

m2.Copep.T2<-gam(Copepods ~  Treatment + s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

m3.Copep.T2<-gam(Copepods ~  s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

T2.Copep.AIC<-AIC(m1.Copep.T2, m2.Copep.T2, m3.Copep.T2)
# best is smoother solo

summary(m1.Copep.T2)
anova.gam(m1.Copep.T2)
gam.check(m1.Copep.T2, rep=1000)
draw(m1.Copep.T2)
concrvity(m1.Copep.T2)
par(mfrow = c(2, 2))
plot(m1.Copep.T2, all.terms = TRUE, page=1)


# model predictions
Copep.diff.T2<-plot_difference(
  m1.Copep.T2,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

# save model diff here,  it matters
Copep.diff.T2 + ggtitle("Day-31 Copepods")
ggsave("figures/Copep.moddiff.T2.pdf", height=4, width=4)

###########  
#plot for the model output on rawdata
Copep.T2.mod.plot<-
  plot_smooths(
  model = m1.Copep.T2,
  series = plant.mass..g,
  comparison=Treatment,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=Copepods, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30)) +
  ggtitle("Day-31") +
  ylab("Copepods density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T3 model
m1.Copep.T3<-gam(Copepods~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = zoop.all, method = "REML")

m2.Copep.T3<-gam(Copepods ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

m3.Copep.T3<-gam(Copepods ~  s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

T3.Copep.AIC<-AIC(m1.Copep.T3, m2.Copep.T3, m3.Copep.T3)
# best is smoother solo

summary(m3.Copep.T3)
anova.gam(m3.Copep.T3)
gam.check(m3.Copep.T3, rep=1000)
draw(m3.Copep.T3)
concrvity(m3.Copep.T3)
par(mfrow = c(2, 2))
plot(m3.Copep.T3, all.terms = TRUE, page=1)


###########  
#plot for the model output on rawdata
Copep.T3.mod.plot<-
  plot_smooths(
  model = m3.Copep.T3,
  series = plant.mass..g
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=Copepods, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30)) +
  ggtitle("Day-59") +
  ylab("Copepods density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T4 model
m1.Copep.T4<-gam(Copepods~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = zoop.all, method = "REML")

m2.Copep.T4<-gam(Copepods ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

m3.Copep.T4<-gam(Copepods ~  s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

T4.Copep.AIC<-AIC(m1.Copep.T4, m2.Copep.T4, m3.Copep.T4)
# best is smoother solo

summary(m3.Copep.T4)
anova.gam(m3.Copep.T4)
gam.check(m3.Copep.T4, rep=1000)
draw(m3.Copep.T4)
concrvity(m3.Copep.T4)
par(mfrow = c(2, 2))
plot(m3.Copep.T4, all.terms = TRUE, page=1)


###########  
#plot for the model output on rawdata
Copep.T4.mod.plot<-
  plot_smooths(
  model = m3.Copep.T4,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=Copepods, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30)) +
  ggtitle("Day-89") +
  ylab("Copepods density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

```

#### Mosquito density 
This is all *Mosquito larvae and pupae*
```{r mosquito model plots, results='hide', fig.show='hide'}

######## T1 model
m1.mos.T1<-gam(mosquito~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.mos.T1<-gam(mosquito ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.mos.T1<-gam(mosquito ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.mos.AIC<-AIC(m1.mos.T1, m2.mos.T1, m3.mos.T1)
# best is smoother solo

summary(m1.mos.T1)
anova.gam(m1.mos.T1)
gam.check(m1.mos.T1, rep=1000)
draw(m1.mos.T1)
concrvity(m1.mos.T1)
par(mfrow = c(2, 2))
plot(m1.mos.T1, all.terms = TRUE, page=1)


# model predictions
mos.diff.T1<-plot_difference(
  m1.mos.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
mos.T1.mod.plot<-
  plot_smooths(
  model = m1.mos.T1,
  series = plant.mass..g,
  comparison=Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=mosquito, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 40)) +
  ggtitle("Day-10") +
  ylab("Mosquito density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T2 model
m1.mos.T2<-gam(mosquito~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = zoop.all, method = "REML")

m2.mos.T2<-gam(mosquito ~  Treatment + s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

m3.mos.T2<-gam(mosquito ~  s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

T2.mos.AIC<-AIC(m1.mos.T2, m2.mos.T2, m3.mos.T2)
# best is smoother solo

summary(m1.mos.T2)
anova.gam(m1.mos.T2)
gam.check(m1.mos.T2, rep=1000)
draw(m1.mos.T2)
concrvity(m1.mos.T2)
par(mfrow = c(2, 2))
plot(m1.mos.T2, all.terms = TRUE, page=1)

# model predictions
mos.diff.T2<-plot_difference(
  m1.mos.T2,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
mos.T2.mod.plot<-
  plot_smooths(
  model = m1.mos.T2,
  series = plant.mass..g,
  comparison= Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=mosquito, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 40)) +
  ggtitle("Day-31") +
  ylab("Mosquito density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T3 model
m1.mos.T3<-gam(mosquito~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = zoop.all, method = "REML")

m2.mos.T3<-gam(mosquito ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

m3.mos.T3<-gam(mosquito ~  s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

T3.mos.AIC<-AIC(m1.mos.T3, m2.mos.T3, m3.mos.T3)
# best is smoother solo

summary(m1.mos.T3)
anova.gam(m1.mos.T3)
gam.check(m1.mos.T3, rep=1000)
draw(m1.mos.T3)
concrvity(m1.mos.T3)
par(mfrow = c(2, 2))
plot(m1.mos.T3, all.terms = TRUE, page=1)


# model predictions
mos.diff.T3<-plot_difference(
  m1.mos.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
mos.T3.mod.plot<-
  plot_smooths(
  model = m1.mos.T3,
  series = plant.mass..g,
  comparison=Treatment,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=mosquito, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 40)) +
  ggtitle("Day-59") +
  ylab("Mosquito density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T4 model
m1.mos.T4<-gam(mosquito~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = zoop.all, method = "REML")

m2.mos.T4<-gam(mosquito ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

m3.mos.T4<-gam(mosquito ~  s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

T4.mos.AIC<-AIC(m1.mos.T4, m2.mos.T4, m3.mos.T4)
# best is smoother solo

summary(m1.mos.T4)
anova.gam(m1.mos.T4)
gam.check(m1.mos.T4, rep=1000)
draw(m1.mos.T4)
concrvity(m1.mos.T4)
par(mfrow = c(2, 2))
plot(m1.mos.T4, all.terms = TRUE, page=1)


# model predictions
mos.diff.T4<-plot_difference(
  m1.mos.T4,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)


###########  
#plot for the model output on rawdata
mos.T4.mod.plot<-
  plot_smooths(
  model = m1.mos.T4,
  series = plant.mass..g,
  comparison= Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=mosquito, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 40)) +
  ggtitle("Day-89") +
  ylab("Mosquito density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

```

* compile outputs from models
* Compiled and single species density plots 
* models for T0 (not vital) and the 4 sampling points: T1-T4  
```{r compiled model outputs, results='hide'}
################

## export model selection parameters
mod.rep<-rep(c("~Treatment + s(plant.mass..g, by= Treatment)", 
              "~Treatment + s(plant.mass..g)", 
              "~s(plant.mass..g)"), times=12)

mod.zoop.df<- data.frame(mod.rep)

AIC.AF<-bind_rows(T1.daphniid.AIC, T2.daphniid.AIC, T3.daphniid.AIC, T4.daphniid.AIC, 
                  T1.Copep.AIC, T2.Copep.AIC, T3.Copep.AIC, T4.Copep.AIC,
                  T1.mos.AIC, T2.mos.AIC, T3.mos.AIC, T4.mos.AIC)
AIC.Zoop.mod<-cbind(mod.zoop.df, AIC.AF)

write.csv(AIC.Zoop.mod, "output/AIC models/AIC.Zoops.csv")
```

```{r compiled plots 3 groups}
### just Daphniidae
Daphniidae.plots<-plot_grid(
  daphniid.T1.mod.plot+ theme(legend.position = "none"),
  daphniid.T2.mod.plot+ theme(legend.position = "none"),
  daphniid.T3.mod.plot+ theme(legend.position = "none"),
  daphniid.T4.mod.plot+ theme(legend.position = "none"),
  extract.legend,
  rel_widths = c(8,8,8,8,3), ncol=5, 
  labels=c('A', 'B', 'C', 'D', ''), label_size=10)


### just Copepods
Copepod.plots<-plot_grid(
  Copep.T1.mod.plot+ theme(legend.position = "none"),
  Copep.T2.mod.plot+ theme(legend.position = "none"),
  Copep.T3.mod.plot+ theme(legend.position = "none"),
  Copep.T4.mod.plot+ theme(legend.position = "none"),
  extract.legend,
  rel_widths = c(8,8,8,8,3), ncol=5, 
  labels=c('A', 'B', 'C', 'D', ''), label_size=10)


#################################### Model plots for mosquitos
######### Mosquito model plots
Mos.plot.dids<-plot_grid(
 mos.diff.T1 + ggtitle("Mosquito Day-10"),
 mos.diff.T2 + ggtitle("Day-31"),
 mos.diff.T3 + ggtitle("Day-59"), 
 mos.diff.T4 + ggtitle("Day-89"),
 rel_widths = c(8,8,8,8), ncol=4)
ggsave("figures/Mos.mod.diff.pdf", height=3, width=11)
  

#################################### Compiled
### compile the Daph and Copepods, Mosquitos
Daph.Cop.Mos<-plot_grid(
  daphniid.T1.mod.plot+ theme(legend.position = "none") + ggtitle("Daphniidae- Day 10"),
  daphniid.T2.mod.plot+ theme(legend.position = "none"),
  daphniid.T3.mod.plot+ theme(legend.position = "none"),
  daphniid.T4.mod.plot+ theme(legend.position = "none"), extract.legend,
  
  Copep.T1.mod.plot+ theme(legend.position = "none") + ggtitle("Copepoda- Day 10"),
  Copep.T2.mod.plot+ theme(legend.position = "none"),
  Copep.T3.mod.plot+ theme(legend.position = "none"),
  Copep.T4.mod.plot+ theme(legend.position = "none"),
  extract.legend,
  
  mos.T1.mod.plot+ theme(legend.position = "none") + ggtitle("Mosquito- Day 10"),
  mos.T2.mod.plot+ theme(legend.position = "none"),
  mos.T3.mod.plot+ theme(legend.position = "none"),
  mos.T4.mod.plot+ theme(legend.position = "none"), extract.legend,
  
  rel_widths = c(8,8,8,8,3, 8,8,8,8,3,8,8,8,8,3), ncol=5, 
  labels=c('A', '', '', '', '',
           'B', '', '', '', '',
           'C', '', '', '', ''), label_size=10)
ggsave("figures/Daph.Cope.Mos.alltimes.pdf", height=12, width=12)
```


**Zooplankton Density stacked bar plot**
* abundance summing to 1.0
```{r, density stacked bar abundance}
zoop.comm<-subset(z.mean.density, spp=="calanoid"|spp=="cyclopoid"|spp=="nauplii"|
             spp=="daphnia"|spp=="ceriodaphnia"|spp=="bosmina"|
             spp=="kellicottia"|spp=="keratella"|spp=="asplanchna"|
             spp=="chironomid"|spp=="mayfly"|spp=="mosquito")

# set structure
make.fac<-c("Time.point", "Treatment", "Tank", "spp")
zoop.comm[make.fac] <- lapply(zoop.comm[make.fac], factor) # make all these factors
zoop.comm$plant.mass..g<-as.numeric(zoop.comm$plant.mass..g)

library('dplyr')

zoop.comm$spp.bin<-dplyr::recode(zoop.comm$spp, 
                         ceriodaphnia = "Daphniidae",
                         daphnia = "Daphniidae",
                         bosmina = "Daphniidae",
                           
                         calanoid = 'Copepoda', 
                         cyclopoid = 'Copepoda',
                         nauplii= 'Copepoda',
                               
                         chironomid = 'Insecta',
                         mayfly= "Insecta",
                         mosquito = 'Culex spp.',
                        
                         kellicottia = 'Rotifera',
                         keratella= 'Rotifera',
                         asplanchna= "Rotifera")

zoop.comm$spp.bin<-factor(zoop.comm$spp.bin, levels=c("Copepoda", "Daphniidae", "Rotifera", "Insecta", "Culex spp."))

zoop.comm$Days<-dplyr::recode(zoop.comm$Time.point, 
                         T0 = "Day-0",
                         T1=  "Day-10",
                         T2 = "Day-31",
                         T3 = "Day-59",
                         T4 = 'Day-89')

z.binmean.density<-summaryBy(Density.mean ~ Days + Tank + Treatment + plant.mass..g +
               spp.bin, data = zoop.comm, FUN = mean)
# rename
z.binmean.density<- z.binmean.density %>% dplyr::rename("Density.mean" = "Density.mean.mean")

# colors
bar.color<-c("orchid", "lightskyblue3", "darkseagreen3", "gold2", "coral")

### make plant material as a factor to reduce white space in bars
z.binmean.density2<-z.binmean.density
z.binmean.density2$plant.mass..g<-as.factor(z.binmean.density2$plant.mass..g)

abundance.density.plot.bin.fac<-ggplot(z.binmean.density2, aes(fill=spp.bin, y=Density.mean, x=plant.mass..g)) +
  scale_fill_manual(values=bar.color, name = "Zoops & Inverts")+
  geom_bar(stat="identity", position="fill")+
  xlab("mean") +
  ylab("Community Proportion") +
  facet_grid(rows=vars(Days), cols=vars(Treatment))+
  labs(x = "plant material (g)") + theme_bw() +
  theme(axis.text.x = element_text(size=8, angle = 90, hjust = 1))

abundance.density.plot.bin.fac
ggsave("figures/Abundance.density.plot.bin.fac.pdf", height=8, width=7)

```

### Greenhouse Gas Isotopes
```{r load GHGs}
GHG<-read.csv("data/Pyro_ghg_d13C.csv")
GHG<-na.omit(GHG) # remove NAs

# set structure
make.fac<-c("Time.point", "Treatment", "Tank", "Gas")
GHG[make.fac] <- lapply(GHG[make.fac], factor) # make all these factors
GHG$plant.mass..g<-as.numeric(GHG$plant.mass..g)

# rename
GHG<- GHG %>% dplyr::rename("GHG.nM" = "GHGwater..nmol.GHG..L.H2O")

# reorder columns and export
GHG<- GHG %>% dplyr::select(Time.point, Treatment, plant.mass..g, Tank, Gas, GHG.nM, d13C)

#############################################

```

### GHG isotopes
What does CO2-d13C look like?
```{r CO2 model plots}
############# GHG plots and models
#### CO2
CO2<-GHG[(GHG$Gas=="CO2"),]

amb.CO2<-(-11.14 + -10.92 + -11.45 + -11.35)/4


#######-- T0

m1.T0.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T0", data = CO2,
            method="REML", family="gaussian")

m2.T0.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T0", data = CO2,
            method="REML", family="gaussian")

m3.T0.CO2.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T0", data = CO2,
            method="REML", family="gaussian")

CO2.d13C.T0.AIC<-AIC(m1.T0.CO2.d13C, m2.T0.CO2.d13C, m3.T0.CO2.d13C)
#factor and global smooth best

summary(m2.T0.CO2.d13C)
anova.gam(m2.T0.CO2.d13C)
gam.check(m2.T0.CO2.d13C, rep=1000)
draw(m2.T0.CO2.d13C)
concrvity(m2.T0.CO2.d13C)
par(mfrow = c(1, 2))
plot(m2.T0.CO2.d13C, all.terms = TRUE, page=1)

# model predictions
CO2.d13C.diff.T0<-plot_difference(
  m1.T0.CO2.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CO2.d13C.T0.mod.plot<-
  plot_smooths(
  model = m2.T0.CO2.d13C,
  series = plant.mass..g,
  comparison = Treatment
)  + theme(legend.position = "none") +
  geom_point(data=CO2[(CO2$Time.point=="T0"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  geom_hline(yintercept=amb.CO2, linetype="dashed", color = "gray60")+
  ylab(expression(paste(delta^{13}, CO[2], " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-0") +
  coord_cartesian(ylim=c(-30, 0)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CO2.d13C.T0.mod.plot

#### CO2 
#######-- T1

m1.T1.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T1", data = CO2,
            method="REML", family="gaussian")

m2.T1.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T1", data = CO2,
            method="REML", family="gaussian")

m3.T1.CO2.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T1", data = CO2,
            method="REML", family="gaussian")

CO2.d13C.T1.AIC<-AIC(m1.T1.CO2.d13C, m2.T1.CO2.d13C, m3.T1.CO2.d13C)
#global smooth best

summary(m3.T1.CO2.d13C)
anova.gam(m3.T1.CO2.d13C)
gam.check(m3.T1.CO2.d13C, rep=1000)
draw(m3.T1.CO2.d13C)
concrvity(m3.T1.CO2.d13C)
par(mfrow = c(1, 2))
plot(m3.T1.CO2.d13C, all.terms = TRUE, page=1)

# model predictions
CO2.d13C.diff.T1<-plot_difference(
  m1.T1.CO2.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CO2.d13C.T1.mod.plot<-
  plot_smooths(
  model = m3.T1.CO2.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CO2[(CO2$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CO[2], " (\u2030, air)"))) +
  geom_hline(yintercept=amb.CO2, linetype="dashed", color = "gray60")+
  xlab("plant material (g)") +
  ggtitle("Time-1") +
  coord_cartesian(ylim=c(-30, 0)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CO2.d13C.T1.mod.plot

#### CO2
#######-- T2


m1.T2.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T2", data = CO2,
            method="REML", family="gaussian")

m2.T2.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T2", data = CO2,
            method="REML", family="gaussian")

m3.T2.CO2.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T2", data = CO2,
            method="REML", family="gaussian")

CO2.d13C.T2.AIC<-AIC(m1.T2.CO2.d13C, m2.T2.CO2.d13C, m3.T2.CO2.d13C)
#global smooth best

summary(m3.T2.CO2.d13C)
anova.gam(m3.T2.CO2.d13C)
gam.check(m3.T2.CO2.d13C, rep=1000)
draw(m3.T2.CO2.d13C)
concrvity(m3.T2.CO2.d13C)
par(mfrow = c(1, 2))
plot(m3.T2.CO2.d13C, all.terms = TRUE, page=1)

# model predictions
CO2.d13C.diff.T2<-plot_difference(
  m1.T2.CO2.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CO2.d13C.T2.mod.plot<-
  plot_smooths(
  model = m3.T2.CO2.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CO2[(CO2$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CO[2], " (\u2030, air)"))) +
  geom_hline(yintercept=amb.CO2, linetype="dashed", color = "gray60")+
  xlab("plant material (g)") +
  ggtitle("Time-2") +
  coord_cartesian(ylim=c(-30,0)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CO2.d13C.T2.mod.plot


#### CO2 
#######-- T3

m1.T3.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T3", data = CO2,
            method="REML", family="gaussian")

m2.T3.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T3", data = CO2,
            method="REML", family="gaussian")

m3.T3.CO2.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T3", data = CO2,
            method="REML", family="gaussian")

CO2.d13C.T3.AIC<-AIC(m1.T3.CO2.d13C, m2.T3.CO2.d13C, m3.T3.CO2.d13C)
#factor smooth best

summary(m1.T3.CO2.d13C)
anova.gam(m1.T3.CO2.d13C)
gam.check(m1.T3.CO2.d13C, rep=1000)
draw(m1.T3.CO2.d13C)
concrvity(m1.T3.CO2.d13C)
par(mfrow = c(1, 2))
plot(m1.T3.CO2.d13C, all.terms = TRUE, page=1)

# model predictions
CO2.d13C.diff.T3<-plot_difference(
  m1.T3.CO2.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CO2.d13C.T3.mod.plot<-
  plot_smooths(
  model = m1.T3.CO2.d13C,
  series = plant.mass..g,
  comparison= Treatment
)  + theme(legend.position = "none") +
  geom_point(data=CO2[(CO2$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CO[2], " (\u2030, air)"))) +
  geom_hline(yintercept=amb.CO2, linetype="dashed", color = "gray60")+
  xlab("plant material (g)") +
  ggtitle("Time-3") +
  coord_cartesian(ylim=c(-30, 0)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CO2.d13C.T3.mod.plot


# models and raw data
CO2.d13C.model.plots<-plot_grid(
  CO2.d13C.T0.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-0"),
  CO2.d13C.T1.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-10"),
  CO2.d13C.T2.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-31"),
  CO2.d13C.T3.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-59"),
  extract.legend, 
  rel_widths = c(8,8,8,8,3), ncol=5)

### model differences
CO2.d13C.plot.diff<-plot_grid(
  CO2.d13C.diff.T0+ ggtitle("CO2-T0"),
  CO2.d13C.diff.T1+ ggtitle("Day-10"),
  CO2.d13C.diff.T2+ ggtitle("Day-31"),
  CO2.d13C.diff.T3+ ggtitle("Day-59"),
  rel_widths = c(8,8,8,8), ncol=4)

## AIC table
mod.ghg.CO2.d13C<-rep(c("Treatment +s(plant.mass..g, by=Treatment)", 
              "Treatment + s(plant.mass..g)", 
              "s(plant.mass..g)"), times=4)

mod.ghg.d13C.df<- data.frame(mod.ghg.CO2.d13C)

AIC.CO2.d13C<-bind_rows(CO2.d13C.T0.AIC, CO2.d13C.T1.AIC, CO2.d13C.T2.AIC, CO2.d13C.T3.AIC)
AIC.CO2.d13C.mod<-cbind(mod.ghg.d13C.df, AIC.CO2.d13C)
write.csv(AIC.CO2.d13C.mod, "output/AIC models/AIC.CO2.d13C.mod.csv")

```

What does CH4-d13C look like?
```{r CH4 model plots}
############# GHG plots and models
#### CH4
CH4<-GHG[(GHG$Gas=="CH4"),]
amb.CH4<- (-46.3 + -46.62 + -46.81)/3

#######-- T0

m1.T0.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T0", data = CH4,
            method="REML", family="gaussian")

m2.T0.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T0", data = CH4,
            method="REML", family="gaussian")

m3.T0.CH4.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T0", data = CH4,
            method="REML", family="gaussian")

CH4.d13C.T0.AIC<-AIC(m1.T0.CH4.d13C, m2.T0.CH4.d13C, m3.T0.CH4.d13C)
# global smooth best

summary(m3.T0.CH4.d13C)
anova.gam(m3.T0.CH4.d13C)
gam.check(m3.T0.CH4.d13C, rep=1000)
draw(m3.T0.CH4.d13C)
concrvity(m3.T0.CH4.d13C)
par(mfrow = c(1, 2))
plot(m3.T0.CH4.d13C, all.terms = TRUE, page=1)

# model predictions
CH4.d13C.diff.T0<-plot_difference(
  m1.T0.CH4.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CH4.d13C.T0.mod.plot<-
  plot_smooths(
  model = m3.T0.CH4.d13C,
  series = plant.mass..g
)  + theme(legend.position = "none") +
  geom_point(data=CH4[(CH4$Time.point=="T0"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CH[4], " (\u2030, air)"))) +
  geom_hline(yintercept=amb.CH4, linetype="dashed", color = "gray60")+
  xlab("plant material (g)") +
  ggtitle("Time-0") +
  coord_cartesian(ylim=c(-50, -42)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CH4.d13C.T0.mod.plot

#### CH4 
#######-- T1

m1.T1.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T1", data = CH4,
            method="REML", family="gaussian")

m2.T1.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T1", data = CH4,
            method="REML", family="gaussian")

m3.T1.CH4.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T1", data = CH4,
            method="REML", family="gaussian")

CH4.d13C.T1.AIC<-AIC(m1.T1.CH4.d13C, m2.T1.CH4.d13C, m3.T1.CH4.d13C)
#global smooth best

summary(m3.T1.CH4.d13C)
anova.gam(m3.T1.CH4.d13C)
gam.check(m3.T1.CH4.d13C, rep=1000)
draw(m3.T1.CH4.d13C)
concrvity(m3.T1.CH4.d13C)
par(mfrow = c(1, 2))
plot(m3.T1.CH4.d13C, all.terms = TRUE, page=1)

# model predictions
CH4.d13C.diff.T1<-plot_difference(
  m1.T1.CH4.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CH4.d13C.T1.mod.plot<-
  plot_smooths(
  model = m3.T1.CH4.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CH4[(CH4$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CH[4], " (\u2030, air)"))) +
  geom_hline(yintercept=amb.CH4, linetype="dashed", color = "gray60")+
  xlab("plant material (g)") +
  ggtitle("Time-1") +
  coord_cartesian(ylim=c(-50, -42)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CH4.d13C.T1.mod.plot

#### CH4
#######-- T2


m1.T2.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T2", data = CH4,
            method="REML", family="gaussian")

m2.T2.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T2", data = CH4,
            method="REML", family="gaussian")

m3.T2.CH4.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T2", data = CH4,
            method="REML", family="gaussian")

CH4.d13C.T2.AIC<-AIC(m1.T2.CH4.d13C, m2.T2.CH4.d13C, m3.T2.CH4.d13C)
#global smooth best

summary(m3.T2.CH4.d13C)
anova.gam(m3.T2.CH4.d13C)
gam.check(m3.T2.CH4.d13C, rep=1000)
draw(m3.T2.CH4.d13C)
concrvity(m3.T2.CH4.d13C)
par(mfrow = c(1, 2))
plot(m3.T2.CH4.d13C, all.terms = TRUE, page=1)

# model predictions
CH4.d13C.diff.T2<-plot_difference(
  m1.T2.CH4.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CH4.d13C.T2.mod.plot<-
  plot_smooths(
  model = m3.T2.CH4.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CH4[(CH4$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CH[4], " (\u2030, air)"))) +
  geom_hline(yintercept=amb.CH4, linetype="dashed", color = "gray60")+
  xlab("plant material (g)") +
  ggtitle("Time-2") +
  coord_cartesian(ylim=c(-50, -42)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CH4.d13C.T2.mod.plot


#### CH4 
#######-- T3

m1.T3.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T3", data = CH4,
            method="REML", family="gaussian")

m2.T3.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T3", data = CH4,
            method="REML", family="gaussian")

m3.T3.CH4.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T3", data = CH4,
            method="REML", family="gaussian")

CH4.d13C.T3.AIC<-AIC(m1.T3.CH4.d13C, m2.T3.CH4.d13C, m3.T3.CH4.d13C)
#factor smooth best

summary(m1.T3.CH4.d13C)
anova.gam(m1.T3.CH4.d13C)
gam.check(m1.T3.CH4.d13C, rep=1000)
draw(m1.T3.CH4.d13C)
concrvity(m1.T3.CH4.d13C)
par(mfrow = c(1, 2))
plot(m1.T3.CH4.d13C, all.terms = TRUE, page=1)

# model predictions
CH4.d13C.diff.T3<-plot_difference(
  m1.T3.CH4.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CH4.d13C.T3.mod.plot<-
  plot_smooths(
  model = m1.T3.CH4.d13C,
  series = plant.mass..g,
  comparison = Treatment
)  + theme(legend.position = "none") +
  geom_point(data=CH4[(CH4$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CH[4], " (\u2030, air)"))) +
  geom_hline(yintercept=amb.CH4, linetype="dashed", color = "gray60")+
  xlab("plant material (g)") +
  ggtitle("Time-4") +
  coord_cartesian(ylim=c(-50, -42)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CH4.d13C.T3.mod.plot


# models and raw data
CH4.d13C.model.plots<-plot_grid(
  CH4.d13C.T0.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-0"),
  CH4.d13C.T1.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-10"),
  CH4.d13C.T2.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-31"),
  CH4.d13C.T3.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-59"),
  extract.legend, 
  rel_widths = c(8,8,8,8,3), ncol=5)

### model differences
CH4.d13C.plot.diff<-plot_grid(
  CH4.d13C.diff.T0+ ggtitle("CH4-T0"),
  CH4.d13C.diff.T1+ ggtitle("Day-10"),
  CH4.d13C.diff.T2+ ggtitle("Day-31"),
  CH4.d13C.diff.T3+ ggtitle("Day-59"),
  rel_widths = c(8,8,8,8), ncol=4)

## AIC table
mod.ghg.CH4.d13C<-rep(c("Treatment +s(plant.mass..g, by=Treatment)", 
              "Treatment + s(plant.mass..g)", 
              "s(plant.mass..g)"), times=4)

mod.ghg.d13C.df<- data.frame(mod.ghg.CH4.d13C)

AIC.CH4.d13C<-bind_rows(CH4.d13C.T0.AIC, CH4.d13C.T1.AIC, CH4.d13C.T2.AIC, CH4.d13C.T3.AIC)
AIC.CH4.d13C.mod<-cbind(mod.ghg.d13C.df, AIC.CH4.d13C)
write.csv(AIC.CH4.d13C.mod, "output/AIC models/AIC.CH4.d13C.mod.csv")

```

Compile the greenhouse gas plots
```{r combine CO2CH4.d13C plots}

GHG.plots<-plot_grid(CO2.d13C.model.plots, CH4.d13C.model.plots, ncol=1)
ggsave("figures/GHG.isotope.mod.plots.pdf", height=7, width=12, encod="MacRoman")


GHG.plot.diff<-plot_grid(CO2.d13C.diff.T3, CH4.d13C.diff.T3, ncol=1)
ggsave("figures/GHG.isotope.mod.diff.pdf", height=7, width=4, encod="MacRoman")


```


###Chlorophyll  
import   
- may not be useful...
```{r chlorophyll, eval =FALSE}
## import treatment IDs
chl.dat<- read.csv("data/Pyro_chlorophyll.csv")  
chl.dat<-chl.dat[!(chl.dat$Time.point=="First.round"),] # remove first round from aborted mission

#remove outlier
chl.out.rem<-chl.dat[!(chl.dat$chla..ug.L>=10),]


#plot

chla.T0<-ggplot(chl.dat[(chl.dat$Time.point=="T0"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-0") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting


chla.T1<-ggplot(chl.dat[(chl.dat$Time.point=="T1"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-1") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T2<-ggplot(chl.dat[(chl.dat$Time.point=="T2"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-2") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T3<-ggplot(chl.dat[(chl.dat$Time.point=="T3"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-3") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T4<-ggplot(chl.dat[(chl.dat$Time.point=="T4"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-4") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting


chl.plots<-plot_grid(
  chla.T0+ theme(legend.position = "none"),
  chla.T2+ theme(legend.position = "none"),
  chla.T2+ theme(legend.position = "none"),
  chla.T3+ theme(legend.position = "none"),
  chla.T4+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,8,8,3), ncol=6)


chl.plots

ggsave("figures/chla.alltime.pdf", height=5, width=15)



```
  