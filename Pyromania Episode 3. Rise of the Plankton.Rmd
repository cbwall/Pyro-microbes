---
title: "Pyromania part 3"
author: "C Wall"
date: "4/20/2022"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

Pyromania data for zooplanktona and chlorophyll
```{r setup chunk, setup, include = FALSE, cache=FALSE, message=FALSE, warning=FALSE}
if (!require('knitr')) install.packages('knitr'); library('knitr')
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center')

# load packages
if (!require("pacman")) install.packages("pacman") # for rapid install if not in library

# use pacman to load all the packages you are missing!
pacman::p_load('knitr', 'lme4', 'lmerTest', 'tidyverse', 'magrittr', 'effects', 'plyr', 'dplyr', 'plotrix', 'car',"gridExtra", "cowplot", "tools", "mgcv", "gratia", "MASS", "stats", "tidymv", "sjstats", "coin", "emmeans", "doBy")

Fig.formatting<-(theme_classic()) +
  theme(text=element_text(size=10),
        axis.line=element_blank(),
        legend.text.align = 0,
        legend.text=element_text(size=10),
        #legend.title = element_blank(),
        panel.border = element_rect(fill=NA, colour = "black", size=1),
        aspect.ratio=1, 
        axis.ticks.length=unit(0.25, "cm"),
        axis.text.y=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=10), 
        axis.text.x=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=8)) +
  theme(legend.key.size = unit(0.4, "cm")) +
  theme(aspect.ratio=1.3) +
  theme(panel.spacing=unit(c(0, 0, 0, 0), "cm"))

```

### FCM
```{r}
fcm.df<-read.csv("data/pyro_fcm_data.csv")

cols<-c("Time.point", "Tank", "Treatment")
fcm.df[cols] <- lapply(fcm.df[cols], factor) # make all these factors
```

Do Autofluorescence
```{r FCM AF, results='hide', fig.show='hide'}
### Time 1
######## T1 model
m1.AF.T1<-gam(af_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = fcm.df, method = "REML")

m2.AF.T1<-gam(af_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = fcm.df, method = "REML")

m3.AF.T1<-gam(af_sum ~  s(plant.mass..g), subset = Time.point=="T1", data = fcm.df, method = "REML")

T1.AF.AIC<-AIC(m1.AF.T1, m2.AF.T1, m3.AF.T1)
# best is smoother solo

summary(m3.AF.T1)
anova.gam(m3.AF.T1)
gam.check(m3.AF.T1, rep=1000)
draw(m3.AF.T1)
concrvity(m3.AF.T1)
par(mfrow = c(2, 2))
plot(m3.AF.T1, all.terms = TRUE, page=1)

# model predictions
AF.diff.T1<-plot_difference(
  m1.AF.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
AF.T1.mod.plot<-
  plot_smooths(
  model = m3.AF.T1,
  series = plant.mass..g,
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=af_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 4000000)) +
  ggtitle("Day-10") +
  ylab("AF sum") +
  xlab("plant material (g)") +
  Fig.formatting


### Time 3
######## T3 model
m1.AF.T3<-gam(af_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = fcm.df, method = "REML")

m2.AF.T3<-gam(af_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = fcm.df, method = "REML")

m3.AF.T3<-gam(af_sum ~  s(plant.mass..g), subset = Time.point=="T3", data = fcm.df, method = "REML")

T3.AF.AIC<-AIC(m1.AF.T3, m2.AF.T3, m3.AF.T3)
# best is smoother solo

summary(m3.AF.T3)
anova.gam(m3.AF.T3)
gam.check(m3.AF.T3, rep=1000)
draw(m3.AF.T3)
concrvity(m3.AF.T3)
par(mfrow = c(2, 2))
plot(m3.AF.T3, all.terms = TRUE, page=1)

# model predictions
AF.diff.T3<-plot_difference(
  m1.AF.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
AF.T3.mod.plot<-
  plot_smooths(
  model = m3.AF.T3,
  series = plant.mass..g,
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=af_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 4000000)) +
  ggtitle("Day-59") +
  ylab("AF sum") +
  xlab("plant material (g)") +
  Fig.formatting


### Time 4
######## T4 model
m1.AF.T4<-gam(af_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = fcm.df, method = "REML")

m2.AF.T4<-gam(af_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = fcm.df, method = "REML")

m3.AF.T4<-gam(af_sum ~  s(plant.mass..g), subset = Time.point=="T4", data = fcm.df, method = "REML")

T4.AF.AIC<-AIC(m1.AF.T4, m2.AF.T4, m3.AF.T4)
# best is smoother solo

summary(m1.AF.T4)
anova.gam(m1.AF.T4)
gam.check(m1.AF.T4, rep=1000)
draw(m1.AF.T4)
concrvity(m1.AF.T4)
par(mfrow = c(2, 2))
plot(m1.AF.T4, all.terms = TRUE, page=1)

# model predictions
AF.diff.T4<-plot_difference(
  m1.AF.T4,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
AF.T4.mod.plot<-
  plot_smooths(
  model = m1.AF.T4,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=af_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 4000000)) +
  ggtitle("Day-89") +
  ylab("AF sum") +
  xlab("plant material (g)") +
  Fig.formatting

```

Now do syber green stained
```{r fcm sg, results='hide', fig.show='hide'}
### Time 1
######## T1 model
m1.SG.T1<-gam(sg_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = fcm.df, method = "REML")

m2.SG.T1<-gam(sg_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = fcm.df, method = "REML")

m3.SG.T1<-gam(sg_sum ~  s(plant.mass..g), subset = Time.point=="T1", data = fcm.df, method = "REML")

T1.SG.AIC<-AIC(m1.SG.T1, m2.SG.T1, m3.SG.T1)
# best is smoother solo

summary(m3.SG.T1)
anova.gam(m3.SG.T1)
gam.check(m3.SG.T1, rep=1000)
draw(m3.SG.T1)
concrvity(m3.SG.T1)
par(mfrow = c(2, 2))
plot(m3.SG.T1, all.terms = TRUE, page=1)

# model predictions
SG.diff.T1<-plot_difference(
  m1.SG.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
SG.T1.mod.plot<-
  plot_smooths(
  model = m3.SG.T1,
  series = plant.mass..g,
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=sg_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30000000)) +
  ggtitle("Day-10") +
  ylab("SG sum") +
  xlab("plant material (g)") +
  Fig.formatting


### Time 3
######## T3 model
m1.SG.T3<-gam(sg_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = fcm.df, method = "REML")

m2.SG.T3<-gam(sg_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = fcm.df, method = "REML")

m3.SG.T3<-gam(sg_sum ~  s(plant.mass..g), subset = Time.point=="T3", data = fcm.df, method = "REML")

T3.SG.AIC<-AIC(m1.SG.T3, m2.SG.T3, m3.SG.T3)
# best is smoother solo

summary(m3.SG.T3)
anova.gam(m3.SG.T3)
gam.check(m3.SG.T3, rep=1000)
draw(m3.SG.T3)
concrvity(m3.SG.T3)
par(mfrow = c(2, 2))
plot(m3.SG.T3, all.terms = TRUE, page=1)

# model predictions
SG.diff.T3<-plot_difference(
  m1.SG.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
SG.T3.mod.plot<-
  plot_smooths(
  model = m3.SG.T3,
  series = plant.mass..g,
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=sg_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30000000)) +
  ggtitle("Day-59") +
  ylab("SG sum") +
  xlab("plant material (g)") +
  Fig.formatting


### Time 4
######## T4 model
m1.SG.T4<-gam(sg_sum ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = fcm.df, method = "REML")

m2.SG.T4<-gam(sg_sum ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = fcm.df, method = "REML")

m3.SG.T4<-gam(sg_sum ~  s(plant.mass..g), subset = Time.point=="T4", data = fcm.df, method = "REML")

T4.SG.AIC<-AIC(m1.SG.T4, m2.SG.T4, m3.SG.T4)
# best is smoother solo

summary(m1.SG.T4)
anova.gam(m1.SG.T4)
gam.check(m1.SG.T4, rep=1000)
draw(m1.SG.T4)
concrvity(m1.SG.T4)
par(mfrow = c(2, 2))
plot(m1.SG.T4, all.terms = TRUE, page=1)

# model predictions
SG.diff.T4<-plot_difference(
  m1.SG.T4,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
SG.T4.mod.plot<-
  plot_smooths(
  model = m1.SG.T4,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=fcm.df[(fcm.df$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=sg_sum, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 30000000)) +
  ggtitle("Day-89") +
  ylab("SG sum") +
  xlab("plant material (g)") +
  Fig.formatting

```

Compile the figures
```{r fcm comp figs}
extract.legend <- get_legend(
  # create some space to the left of the legend
  SG.T4.mod.plot + theme(legend.box.margin = margin(0, 0, 0, 10)))


FCM.alltimes<-plot_grid(
  AF.T1.mod.plot+ theme(legend.position = "none"),
  AF.T3.mod.plot+ theme(legend.position = "none"),
  AF.T4.mod.plot+ theme(legend.position = "none"), extract.legend,
  SG.T1.mod.plot+ theme(legend.position = "none"),
  SG.T3.mod.plot+ theme(legend.position = "none"),
  SG.T4.mod.plot+ theme(legend.position = "none"), extract.legend,
  rel_widths = c(8,8,8,3, 8,8,8,3), ncol=4)
ggsave("figures/FCM.alltimes.mod.pdf", height=6, width=9)

FCM.alltimes



#### model fits
FCM.mod.dif<-plot_grid(
  AF.diff.T1+ theme(legend.position = "none")+ ggtitle("AF Day-10"),
  AF.diff.T3+ theme(legend.position = "none")+ ggtitle("AF-Day-59"),
  AF.diff.T4+ theme(legend.position = "none")+ ggtitle("AF-Day-89"),
  SG.diff.T1+ theme(legend.position = "none")+ ggtitle("SG Day-10"),
  SG.diff.T3+ theme(legend.position = "none")+ ggtitle("SG-Day-59"),
  SG.diff.T4+ theme(legend.position = "none")+ ggtitle("SG-Day-89"),
  rel_widths = c(8,8,8,8,8,8), ncol=3)
ggsave("figures/FCM.mod.diff.pdf", height=6, width=9)

FCM.alltimes
```


### Zooplankton
integrating the zooplankton counting data and code from Jon into the markdown.

```{r zoop data}
plank<-read.csv("data/zooplankton/Pyro_Master zoop data.csv")
names(plank)

plank<-  plyr::rename(plank, c("TANK" = "Tank", 
                               "DATE.COLLECTED" = "Date.collected",
                               "X.COUNTED"= "Number.counted", 
                               "COUNTED.ON"= "Count.date",
                               "COUNTED.BY" = "Counted.by", 
                               "SPECIES" = "Species",
                               "X..OF.INDIVIDUALS" = "Number.of.individ"))



vols<-read.csv("data/zooplankton/Pyro_plankton.volume.csv")
names(vols)<-c("Date.collected","Time.point","Treatment","plant.mass..g","Tank","Volume.sampled..mL")

# fixing dates
vols$Date.collected<-as.factor(as.POSIXct(vols$Date.collected, format="%m/%d/%Y"))
plank$Date.collected<-as.factor(plank$Date.collected)

# fixing dates that have wrong year
plank$Date.collected[plank$Date.collected=="2022-11-03"]<-"2021-11-03"
plank$Date.collected[plank$Date.collected=="2022-11-15"]<-"2021-11-15"
plank$Date.collected[plank$Date.collected=="2022-12-06"]<-"2021-12-06"

#drop levels
plank<-droplevels(plank)
#inspect table
table(plank$Date.collected, plank$Time.point)

zoop<-merge(plank, vols, by=c("Tank","Date.collected","Time.point"), all=T)
levels(as.factor(zoop$Date.collected))
summary(zoop)

table(zoop$Time.point, zoop$Tank)
table(zoop$Counted.by, zoop$Tank)

levels(as.factor(zoop$Species))

# rename species
zoop<-zoop %>%
  mutate(Species = fct_recode(`Species`,
                              "Mosquito"    = "Mosquito Larvae",
                              "Mosquito"    = "Mosquito Pupae ?",
                              "Mosquito"    = "Mosquito larvae",
                              "Mayfly"    = "Mayfly larvae",
                              "Mayfly"    = "Mayfly larva",
                              "Ephipium"  = "Epliphium"))

levels(as.factor(zoop$Species))


zoop$spp <- casefold(zoop$Species, upper = FALSE)
levels(as.factor(zoop$spp))
str(zoop)

# calculate density
# originally as mL of volume samples, multiply by 1000 to get planton per liter
zoop$Density<-1000*zoop$Number.of.individ/zoop$Volume.sampled..mL

levels(as.factor(zoop$Date.collected))

table(zoop$Tank[zoop$Date.collected=="2021-11-03"], zoop$spp[zoop$Date.collected=="2021-11-03"])

# reorder columns and export
zoop<- zoop %>% select(Time.point, Date.collected, Treatment, plant.mass..g, Tank, spp, Density)

write.csv(zoop, "output/Pyro_zoop_cleaned.csv")
#############################################

# make summary dataframe

z.df<-zoop
z<-summaryBy(Density ~ Tank + Date.collected + Time.point + Treatment + plant.mass..g +
               spp, data = z.df, FUN = mean)
```

### Daphnia density  
* models for T0 (not vital) and the 4 sampling points: T1-T4  
```{r zoop model plots}
######### Daphnia

zoop.all<-pivot_wider(z, names_from="spp", values_from="Density.mean")
zoop.all[is.na(zoop.all)]<-0
names(zoop.all)[21]<-"burst_daphnia"
zoop.all$all_daphnia<-zoop.all$daphnia+zoop.all$burst_daphnia

zoop.all<-as.data.frame(zoop.all)
cols2<-c("Time.point", "Tank", "Date.collected", "Treatment")
zoop.all[cols2] <- lapply(zoop.all[cols2], factor) # make all these factors

######### 


######## T0 model
m1.daph.T0<-gam(all_daphnia~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T0", data = zoop.all, method = "REML")

m2.daph.T0<-gam(all_daphnia ~  Treatment + s(plant.mass..g), subset = Time.point=="T0", data = zoop.all, method = "REML")

m3.daph.T0<-gam(all_daphnia ~  s(plant.mass..g), subset = Time.point=="T0", data = zoop.all, method = "REML")

T0.daph.AIC<-AIC(m1.daph.T0, m2.daph.T0, m3.daph.T0)
# best is smoother solo

summary(m3.daph.T0)
anova.gam(m3.daph.T0)
gam.check(m3.daph.T0, rep=1000)
draw(m3.daph.T0)
concrvity(m3.daph.T0)
par(mfrow = c(2, 2))
plot(m3.daph.T0, all.terms = TRUE, page=1)

###########  
#plot for the model output on rawdata
daph.T0.mod.plot<-
  plot_smooths(
  model = m3.daph.T0,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T0"),], 
             aes(x=plant.mass..g, y=all_daphnia, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-0") +
  ylab("Daphnia density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



######## T1 model
m1.daph.T1<-gam(all_daphnia~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.daph.T1<-gam(all_daphnia ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.daph.T1<-gam(all_daphnia ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.daph.AIC<-AIC(m1.daph.T1, m2.daph.T1, m3.daph.T1)
# best is smoother solo

summary(m3.daph.T1)
anova.gam(m3.daph.T1)
gam.check(m3.daph.T1, rep=1000)
draw(m3.daph.T1)
concrvity(m3.daph.T1)
par(mfrow = c(2, 2))
plot(m3.daph.T1, all.terms = TRUE, page=1)

###########  
#plot for the model output on rawdata
daph.T1.mod.plot<-
  plot_smooths(
  model = m3.daph.T1,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=all_daphnia, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-10") +
  ylab("Daphnia density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T2 model
m1.daph.T2<-gam(all_daphnia~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = zoop.all, method = "REML")

m2.daph.T2<-gam(all_daphnia ~  Treatment + s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

m3.daph.T2<-gam(all_daphnia ~  s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

T2.daph.AIC<-AIC(m1.daph.T2, m2.daph.T2, m3.daph.T2)
# best is smoother solo

summary(m3.daph.T2)
anova.gam(m3.daph.T2)
gam.check(m3.daph.T2, rep=1000)
draw(m3.daph.T2)
concrvity(m3.daph.T2)
par(mfrow = c(2, 2))
plot(m3.daph.T2, all.terms = TRUE, page=1)


###########  
#plot for the model output on rawdata
daph.T2.mod.plot<-
  plot_smooths(
  model = m3.daph.T2,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=all_daphnia, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-31") +
  ylab("Daphnia density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T3 model
m1.daph.T3<-gam(all_daphnia~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = zoop.all, method = "REML")

m2.daph.T3<-gam(all_daphnia ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

m3.daph.T3<-gam(all_daphnia ~  s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

T3.daph.AIC<-AIC(m1.daph.T3, m2.daph.T3, m3.daph.T3)
# best is smoother solo

summary(m1.daph.T3)
anova.gam(m1.daph.T3)
gam.check(m1.daph.T3, rep=1000)
draw(m1.daph.T3)
concrvity(m1.daph.T3)
par(mfrow = c(2, 2))
plot(m1.daph.T3, all.terms = TRUE, page=1)


# model predictions
Daph.diff.T3<-plot_difference(
  m1.daph.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

Daph.T3.diff.plot<-plot_grid(Daph.diff.T3 + ggtitle("Daphnia, Day-59"))
ggsave("figures/Daph.diff.T3.pdf", height=4, width=4)


###########  
#plot for the model output on rawdata
daph.T3.mod.plot<-
  plot_smooths(
  model = m1.daph.T3,
  series = plant.mass..g,
  comparison=Treatment,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=all_daphnia, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-59") +
  ylab("Daphnia density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T4 model
m1.daph.T4<-gam(all_daphnia~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = zoop.all, method = "REML")

m2.daph.T4<-gam(all_daphnia ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

m3.daph.T4<-gam(all_daphnia ~  s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

T4.daph.AIC<-AIC(m1.daph.T4, m2.daph.T4, m3.daph.T4)
# best is smoother solo

summary(m3.daph.T4)
anova.gam(m3.daph.T4)
gam.check(m3.daph.T4, rep=1000)
draw(m3.daph.T4)
concrvity(m3.daph.T4)
par(mfrow = c(2, 2))
plot(m3.daph.T4, all.terms = TRUE, page=1)



###########  
#plot for the model output on rawdata
daph.T4.mod.plot<-
  plot_smooths(
  model = m3.daph.T4,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=all_daphnia, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Day-89") +
  ylab("Daphnia density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

```

### Mosquito density  
* models the 4 sampling points: T1-T4  
```{r mosquito model plots}

######## T1 model
m1.mos.T1<-gam(mosquito~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.mos.T1<-gam(mosquito ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.mos.T1<-gam(mosquito ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.mos.AIC<-AIC(m1.mos.T1, m2.mos.T1, m3.mos.T1)
# best is smoother solo

summary(m1.mos.T1)
anova.gam(m1.mos.T1)
gam.check(m1.mos.T1, rep=1000)
draw(m1.mos.T1)
concrvity(m1.mos.T1)
par(mfrow = c(2, 2))
plot(m1.mos.T1, all.terms = TRUE, page=1)


# model predictions
mos.diff.T1<-plot_difference(
  m1.mos.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
mos.T1.mod.plot<-
  plot_smooths(
  model = m1.mos.T1,
  series = plant.mass..g,
  comparison=Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=mosquito, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 40)) +
  ggtitle("Day-10") +
  ylab("Mosquito density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T2 model
m1.mos.T2<-gam(mosquito~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = zoop.all, method = "REML")

m2.mos.T2<-gam(mosquito ~  Treatment + s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

m3.mos.T2<-gam(mosquito ~  s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

T2.mos.AIC<-AIC(m1.mos.T2, m2.mos.T2, m3.mos.T2)
# best is smoother solo

summary(m1.mos.T2)
anova.gam(m1.mos.T2)
gam.check(m1.mos.T2, rep=1000)
draw(m1.mos.T2)
concrvity(m1.mos.T2)
par(mfrow = c(2, 2))
plot(m1.mos.T2, all.terms = TRUE, page=1)

# model predictions
mos.diff.T2<-plot_difference(
  m1.mos.T2,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
mos.T2.mod.plot<-
  plot_smooths(
  model = m1.mos.T2,
  series = plant.mass..g,
  comparison= Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=mosquito, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 40)) +
  ggtitle("Day-31") +
  ylab("Mosquito density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T3 model
m1.mos.T3<-gam(mosquito~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = zoop.all, method = "REML")

m2.mos.T3<-gam(mosquito ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

m3.mos.T3<-gam(mosquito ~  s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

T3.mos.AIC<-AIC(m1.mos.T3, m2.mos.T3, m3.mos.T3)
# best is smoother solo

summary(m1.mos.T3)
anova.gam(m1.mos.T3)
gam.check(m1.mos.T3, rep=1000)
draw(m1.mos.T3)
concrvity(m1.mos.T3)
par(mfrow = c(2, 2))
plot(m1.mos.T3, all.terms = TRUE, page=1)


# model predictions
mos.diff.T3<-plot_difference(
  m1.mos.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
mos.T3.mod.plot<-
  plot_smooths(
  model = m1.mos.T3,
  series = plant.mass..g,
  comparison=Treatment,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=mosquito, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 40)) +
  ggtitle("Day-59") +
  ylab("Mosquito density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T4 model
m1.mos.T4<-gam(mosquito~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = zoop.all, method = "REML")

m2.mos.T4<-gam(mosquito ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

m3.mos.T4<-gam(mosquito ~  s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

T4.mos.AIC<-AIC(m1.mos.T4, m2.mos.T4, m3.mos.T4)
# best is smoother solo

summary(m1.mos.T4)
anova.gam(m1.mos.T4)
gam.check(m1.mos.T4, rep=1000)
draw(m1.mos.T4)
concrvity(m1.mos.T4)
par(mfrow = c(2, 2))
plot(m1.mos.T4, all.terms = TRUE, page=1)


# model predictions
mos.diff.T4<-plot_difference(
  m1.mos.T4,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)


###########  
#plot for the model output on rawdata
mos.T4.mod.plot<-
  plot_smooths(
  model = m1.mos.T4,
  series = plant.mass..g,
  comparison= Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=mosquito, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 40)) +
  ggtitle("Day-89") +
  ylab("Mosquito density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

```

### Calanoid density
```{r, Calanoid}
# Calanoid

######## T1 model
m1.calan.T1<-gam(calanoid~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.calan.T1<-gam(calanoid ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.calan.T1<-gam(calanoid ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.calan.AIC<-AIC(m1.calan.T1, m2.calan.T1, m3.calan.T1)
# best is smoother solo

summary(m1.calan.T1)
anova.gam(m1.calan.T1)
gam.check(m1.calan.T1, rep=1000)
draw(m1.calan.T1)
concrvity(m1.calan.T1)
par(mfrow = c(2, 2))
plot(m1.calan.T1, all.terms = TRUE, page=1)


# model predictions
calan.diff.T1<-plot_difference(
  m1.calan.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
calan.T1.mod.plot<-
  plot_smooths(
  model = m1.calan.T1,
  series = plant.mass..g,
  comparison=Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=calanoid, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 8)) +
  ggtitle("Day-10") +
  ylab("calanoid density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T2 model
m1.calan.T2<-gam(calanoid~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = zoop.all, method = "REML")

m2.calan.T2<-gam(calanoid ~  Treatment + s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

m3.calan.T2<-gam(calanoid ~  s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

T2.calan.AIC<-AIC(m1.calan.T2, m2.calan.T2, m3.calan.T2)
# best is smoother solo

summary(m3.calan.T2)
anova.gam(m3.calan.T2)
gam.check(m3.calan.T2, rep=1000)
draw(m3.calan.T2)
concrvity(m3.calan.T2)
par(mfrow = c(2, 2))
plot(m3.calan.T2, all.terms = TRUE, page=1)

# model predictions
calan.diff.T2<-plot_difference(
  m3.calan.T2,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
calan.T2.mod.plot<-
  plot_smooths(
  model = m3.calan.T2,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=calanoid, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 8)) +
  ggtitle("Day-31") +
  ylab("calanoid density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T3 model
m1.calan.T3<-gam(calanoid~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = zoop.all, method = "REML")

m2.calan.T3<-gam(calanoid ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

m3.calan.T3<-gam(calanoid ~  s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

T3.calan.AIC<-AIC(m1.calan.T3, m2.calan.T3, m3.calan.T3)
# best is smoother solo

summary(m1.calan.T3)
anova.gam(m1.calan.T3)
gam.check(m1.calan.T3, rep=1000)
draw(m1.calan.T3)
concrvity(m1.calan.T3)
par(mfrow = c(2, 2))
plot(m1.calan.T3, all.terms = TRUE, page=1)


# model predictions
calan.diff.T3<-plot_difference(
  m1.calan.T3,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
calan.T3.mod.plot<-
  plot_smooths(
  model = m1.calan.T3,
  series = plant.mass..g,
  comparison=Treatment,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=calanoid, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 8)) +
  ggtitle("Day-59") +
  ylab("calanoid density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T4 model
m1.calan.T4<-gam(calanoid~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = zoop.all, method = "REML")

m2.calan.T4<-gam(calanoid ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

m3.calan.T4<-gam(calanoid ~  s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

T4.calan.AIC<-AIC(m1.calan.T4, m2.calan.T4, m3.calan.T4)
# best is smoother solo

summary(m2.calan.T4)
anova.gam(m2.calan.T4)
gam.check(m2.calan.T4, rep=1000)
draw(m2.calan.T4)
concrvity(m2.calan.T4)
par(mfrow = c(2, 2))
plot(m2.calan.T4, all.terms = TRUE, page=1)


# model predictions
calan.diff.T4<-plot_difference(
  m2.calan.T4,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)


###########  
#plot for the model output on rawdata
calan.T4.mod.plot<-
  plot_smooths(
  model = m2.calan.T4,
  series = plant.mass..g,
  comparison= Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=calanoid, color=Treatment)) +
  geom_line(aes(fill=Treatment, linetype=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 8)) +
  ggtitle("Day-89") +
  ylab("calanoid density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

```

### Cyclopoid density
```{r, Cyclopoid}
# cyclopoid

######## T1 model
m1.cyclo.T1<-gam(cyclopoid~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.cyclo.T1<-gam(cyclopoid ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.cyclo.T1<-gam(cyclopoid ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.cyclo.AIC<-AIC(m1.cyclo.T1, m2.cyclo.T1, m3.cyclo.T1)
# best is smoother solo

summary(m1.cyclo.T1)
anova.gam(m1.cyclo.T1)
gam.check(m1.cyclo.T1, rep=1000)
draw(m1.cyclo.T1)
concrvity(m1.cyclo.T1)
par(mfrow = c(2, 2))
plot(m1.cyclo.T1, all.terms = TRUE, page=1)


# model predictions
cyclo.diff.T1<-plot_difference(
  m1.cyclo.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
cyclo.T1.mod.plot<-
  plot_smooths(
  model = m1.cyclo.T1,
  series = plant.mass..g,
  comparison=Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=cyclopoid, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 15)) +
  ggtitle("Day-10") +
  ylab("cyclopoid density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T2 model
m1.cyclo.T2<-gam(cyclopoid~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = zoop.all, method = "REML")

m2.cyclo.T2<-gam(cyclopoid ~  Treatment + s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

m3.cyclo.T2<-gam(cyclopoid ~  s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

T2.cyclo.AIC<-AIC(m1.cyclo.T2, m2.cyclo.T2, m3.cyclo.T2)
# best is smoother solo

summary(m3.cyclo.T2)
anova.gam(m3.cyclo.T2)
gam.check(m3.cyclo.T2, rep=1000)
draw(m3.cyclo.T2)
concrvity(m3.cyclo.T2)
par(mfrow = c(2, 2))
plot(m3.cyclo.T2, all.terms = TRUE, page=1)



###########  
#plot for the model output on rawdata
cyclo.T2.mod.plot<-
  plot_smooths(
  model = m3.cyclo.T2,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=cyclopoid, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 8)) +
  ggtitle("Day-31") +
  ylab("cyclopoid density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T3 model
m1.cyclo.T3<-gam(cyclopoid~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = zoop.all, method = "REML")

m2.cyclo.T3<-gam(cyclopoid ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

m3.cyclo.T3<-gam(cyclopoid ~  s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

T3.cyclo.AIC<-AIC(m1.cyclo.T3, m2.cyclo.T3, m3.cyclo.T3)
# best is smoother solo

summary(m3.cyclo.T3)
anova.gam(m3.cyclo.T3)
gam.check(m3.cyclo.T3, rep=1000)
draw(m3.cyclo.T3)
concrvity(m3.cyclo.T3)
par(mfrow = c(2, 2))
plot(m3.cyclo.T3, all.terms = TRUE, page=1)


###########  
#plot for the model output on rawdata
cyclo.T3.mod.plot<-
  plot_smooths(
  model = m3.cyclo.T3,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=cyclopoid, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 8)) +
  ggtitle("Day-59") +
  ylab("cyclopoid density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T4 model
m1.cyclo.T4<-gam(cyclopoid~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = zoop.all, method = "REML")

m2.cyclo.T4<-gam(cyclopoid ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

m3.cyclo.T4<-gam(cyclopoid ~  s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

T4.cyclo.AIC<-AIC(m1.cyclo.T4, m2.cyclo.T4, m3.cyclo.T4)
# best is smoother solo

summary(m3.cyclo.T4)
anova.gam(m3.cyclo.T4)
gam.check(m3.cyclo.T4, rep=1000)
draw(m3.cyclo.T4)
concrvity(m3.cyclo.T4)
par(mfrow = c(2, 2))
plot(m3.cyclo.T4, all.terms = TRUE, page=1)


###########  
#plot for the model output on rawdata
cyclo.T4.mod.plot<-
  plot_smooths(
  model = m3.cyclo.T4,
  series = plant.mass..g
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=cyclopoid, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 8)) +
  ggtitle("Day-89") +
  ylab("cyclopoid density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

```

### Kellicottia density
```{r, Kellicottia}
# cyclopoid

######## T1 model
m1.kelli.T1<-gam(kellicottia~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.kelli.T1<-gam(kellicottia ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.kelli.T1<-gam(kellicottia ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.kelli.AIC<-AIC(m1.kelli.T1, m2.kelli.T1, m3.kelli.T1)
# best is smoother solo

summary(m1.kelli.T1)
anova.gam(m1.kelli.T1)
gam.check(m1.kelli.T1, rep=1000)
draw(m1.kelli.T1)
concrvity(m1.kelli.T1)
par(mfrow = c(2, 2))
plot(m1.kelli.T1, all.terms = TRUE, page=1)


# model predictions
kelli.diff.T1<-plot_difference(
  m1.kelli.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
kelli.T1.mod.plot<-
  plot_smooths(
  model = m1.kelli.T1,
  series = plant.mass..g,
  comparison=Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=kellicottia, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 5)) +
  ggtitle("Day-10") +
  ylab("kellicottia density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

#### not enough observations in other time points
```

### Nauplii density
```{r, Nauplii}
# Nauplii

######## T1 model
m1.naup.T1<-gam(nauplii~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = zoop.all, method = "REML")

m2.naup.T1<-gam(nauplii ~  Treatment + s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

m3.naup.T1<-gam(nauplii ~  s(plant.mass..g), subset = Time.point=="T1", data = zoop.all, method = "REML")

T1.naup.AIC<-AIC(m1.naup.T1, m2.naup.T1, m3.naup.T1)
# best is smoother solo

summary(m1.naup.T1)
anova.gam(m1.naup.T1)
gam.check(m1.naup.T1, rep=1000)
draw(m1.naup.T1)
concrvity(m1.naup.T1)
par(mfrow = c(2, 2))
plot(m1.naup.T1, all.terms = TRUE, page=1)


# model predictions
naup.diff.T1<-plot_difference(
  m1.naup.T1,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
naup.T1.mod.plot<-
  plot_smooths(
  model = m1.naup.T1,
  series = plant.mass..g,
  comparison=Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=nauplii, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Day-10") +
  ylab("nauplii density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T2 model
m1.naup.T2<-gam(nauplii~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = zoop.all, method = "REML")

m2.naup.T2<-gam(nauplii ~  Treatment + s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

m3.naup.T2<-gam(nauplii ~  s(plant.mass..g), subset = Time.point=="T2", data = zoop.all, method = "REML")

T2.naup.AIC<-AIC(m1.naup.T2, m2.naup.T2, m3.naup.T2)
# best is smoother solo

summary(m1.naup.T2)
anova.gam(m1.naup.T2)
gam.check(m1.naup.T2, rep=1000)
draw(m1.naup.T2)
concrvity(m1.naup.T2)
par(mfrow = c(2, 2))
plot(m1.naup.T2, all.terms = TRUE, page=1)



###########  
#plot for the model output on rawdata
naup.T2.mod.plot<-
  plot_smooths(
  model = m1.naup.T2,
  series = plant.mass..g,
  comparison=Treatment
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=nauplii, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Day-31") +
  ylab("nauplii density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting



############################
######## T3 model
m1.naup.T3<-gam(nauplii~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = zoop.all, method = "REML")

m2.naup.T3<-gam(nauplii ~  Treatment + s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

m3.naup.T3<-gam(nauplii ~  s(plant.mass..g), subset = Time.point=="T3", data = zoop.all, method = "REML")

T3.naup.AIC<-AIC(m1.naup.T3, m2.naup.T3, m3.naup.T3)
# best is smoother solo

summary(m3.naup.T3)
anova.gam(m3.naup.T3)
gam.check(m3.naup.T3, rep=1000)
draw(m3.naup.T3)
concrvity(m3.naup.T3)
par(mfrow = c(2, 2))
plot(m3.naup.T3, all.terms = TRUE, page=1)


###########  
#plot for the model output on rawdata
naup.T3.mod.plot<-
  plot_smooths(
  model = m3.naup.T3,
  series = plant.mass..g,
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=nauplii, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Day-59") +
  ylab("nauplii density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting


############################
######## T4 model
m1.naup.T4<-gam(nauplii~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = zoop.all, method = "REML")

m2.naup.T4<-gam(nauplii ~  Treatment + s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

m3.naup.T4<-gam(nauplii ~  s(plant.mass..g), subset = Time.point=="T4", data = zoop.all, method = "REML")

T4.naup.AIC<-AIC(m1.naup.T4, m2.naup.T4, m3.naup.T4)
# best is smoother solo

summary(m3.naup.T4)
anova.gam(m3.naup.T4)
gam.check(m3.naup.T4, rep=1000)
draw(m3.naup.T4)
concrvity(m3.naup.T4)
par(mfrow = c(2, 2))
plot(m3.naup.T4, all.terms = TRUE, page=1)


###########  
#plot for the model output on rawdata
naup.T4.mod.plot<-
  plot_smooths(
  model = m3.naup.T4,
  series = plant.mass..g
) + 
  geom_point(data=zoop.all[(zoop.all$Time.point=="T4"),], 
             aes(x=plant.mass..g, y=nauplii, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Day-89") +
  ylab("nauplii density (#/L)") +
  xlab("plant material (g)") +
  Fig.formatting

```

### Compiled and single species density plots 
* models for T0 (not vital) and the 4 sampling points: T1-T4  
```{r compiled plots}
# compile figs

### just daphnia
Daph.plots<-plot_grid(
  daph.T1.mod.plot+ theme(legend.position = "none"),
  daph.T2.mod.plot+ theme(legend.position = "none"),
  daph.T3.mod.plot+ theme(legend.position = "none"),
  daph.T4.mod.plot+ theme(legend.position = "none"),
  extract.legend,
  rel_widths = c(8,8,8,8,3), ncol=5, 
  labels=c('A', 'B', 'C', 'D', ''), label_size=10)
ggsave("figures/Daph.alltimes.mod.pdf", height=6, width=12)


### just Mosquitos
Mos.plots<-plot_grid(
  mos.T1.mod.plot+ theme(legend.position = "none"),
  mos.T2.mod.plot+ theme(legend.position = "none"),
  mos.T3.mod.plot+ theme(legend.position = "none"),
  mos.T4.mod.plot+ theme(legend.position = "none"),
  extract.legend,
  rel_widths = c(8,8,8,8, 3), ncol=5)
ggsave("figures/Mos.alltimes.mod.pdf", height=6, width=12)


### just Calanoids
Cal.plots<-plot_grid(
  calan.T1.mod.plot+ theme(legend.position = "none"),
  calan.T2.mod.plot+ theme(legend.position = "none"),
  calan.T3.mod.plot+ theme(legend.position = "none"),
  calan.T4.mod.plot+ theme(legend.position = "none"),
  extract.legend,
  rel_widths = c(8,8,8,8, 3), ncol=5)
ggsave("figures/Calanoid.alltimes.mod.pdf", height=6, width=12)


### just Cyclopoids
Cycl.plots<-plot_grid(
  cyclo.T1.mod.plot+ theme(legend.position = "none"),
  cyclo.T2.mod.plot+ theme(legend.position = "none"),
  cyclo.T3.mod.plot+ theme(legend.position = "none"),
  cyclo.T4.mod.plot+ theme(legend.position = "none"),
  extract.legend,
  rel_widths = c(8,8,8,8, 3), ncol=5)
ggsave("figures/Cyclopoid.alltimes.mod.pdf", height=6, width=12)


### just Nauplii
Naupl.plots<-plot_grid(
  naup.T1.mod.plot+ theme(legend.position = "none"),
  naup.T2.mod.plot+ theme(legend.position = "none"),
  naup.T3.mod.plot+ theme(legend.position = "none"),
  naup.T4.mod.plot+ theme(legend.position = "none"),
  extract.legend,
  rel_widths = c(8,8,8,8, 3), ncol=5)
ggsave("figures/Naupl.alltimes.mod.pdf", height=6, width=12)


### just Kellicottia
Kellic.plots<-plot_grid(
  kelli.T1.mod.plot, ncol=1)
ggsave("figures/Kellicottia.alltimes.mod.pdf", height=6, width=12)




#################################### Model plots for mosquitos
######### Mosquito model plots
Mos.plot.dids<-plot_grid(
 mos.diff.T1 + theme(legend.position = "Mosquito Day-10"),
 mos.diff.T2 + theme(legend.position = "Day-31"),
 mos.diff.T3 + theme(legend.position = "Day-59"), 
 mos.diff.T4 + theme(legend.position = "Day-89"),
 rel_widths = c(8,8,8,8), ncol=4)
ggsave("figures/Mos.mod.diff.pdf", height=3, width=11)
  

#################################### Compiled
### compile the Daph and Mosquitos
Daph.Mos<-plot_grid(
  daph.T1.mod.plot+ theme(legend.position = "none"),
  daph.T2.mod.plot+ theme(legend.position = "none"),
  daph.T3.mod.plot+ theme(legend.position = "none"),
  daph.T4.mod.plot+ theme(legend.position = "none"), extract.legend,
  
  mos.T1.mod.plot+ theme(legend.position = "none"),
  mos.T2.mod.plot+ theme(legend.position = "none"),
  mos.T3.mod.plot+ theme(legend.position = "none"),
  mos.T4.mod.plot+ theme(legend.position = "none"), extract.legend,
  
  rel_widths = c(8,8,8,8,3, 8,8,8,8,3), ncol=5, 
  labels=c('A', '', '', '', '',
           'B', '', '', '', ''), label_size=10)
ggsave("figures/Daph.Mos.alltimes.pdf", height=8, width=12)
```

### Density stacked bar plot
* abundance summing to 1.0
```{r, density stacked bar abundance}
z2<-summaryBy(Density.mean ~ spp, data = z, FUN = c(mean, max, min))

z3<-subset(z, spp=="calanoid"|spp=="ceriodaphnia"|spp=="chironomid"|spp=="cyclopoid"|
             spp=="daphnia"|spp=="kellicottia"|spp=="keratella"|spp=="mayfly"|spp=="mosquito"|
             spp=="nauplii")
levels(as.factor(z$spp))

# set structure
make.fac<-c("Time.point", "Treatment", "Tank", "spp")
z3[make.fac] <- lapply(z3[make.fac], factor) # make all these factors
z3$plant.mass..g<-as.numeric(z3$plant.mass..g)


p7<-ggplot(z3,aes(fill=spp, y=Density.mean, x=plant.mass..g)) +
  geom_bar(stat="identity", position="fill", width = 12)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(rows=vars(Date.collected), cols=vars(Treatment))+
  labs(x = "Treatment")
p7
```

### Density stacked bar plot v2
* stacked bar with density sum  
* gam approach for density
```{r}
# big stacked plot
p8<-ggplot(z3,aes(fill=spp, y=Density.mean, x=plant.mass..g)) +
  geom_bar(stat="identity", width = 12)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(rows=vars(Date.collected), cols=vars(Treatment), scales="fixed")+
  labs(x = "Treatment")
p8 #position="fill"

```


```{r PCAs}

z4<-pivot_wider(z3, names_from = spp, values_from = Density.mean)
z4[is.na(z4)]<-0
names(z4)

PCA1 <- prcomp(subset(z4, Time.point %in% "T1")[,c(6:15)], center = TRUE)
PCA2 <- prcomp(subset(z4, Time.point %in% "T2")[,c(6:15)], center = TRUE)
PCA3 <- prcomp(subset(z4, Time.point %in% "T3")[,c(6:15)], center = TRUE)
PCA4 <- prcomp(subset(z4, Time.point %in% "T4")[,c(6:15)], center = TRUE)
```


```{r, T1 PCA}
#TIME 1
scores1<-as.data.frame(PCA1$x[,c(1,2)])
scores1<-cbind(scores1,as.data.frame(subset(z4, Time.point %in% "T1"))[,c(1,4,5)] )
ecor1<-as.data.frame(PCA1$rotation[,c(1:2)])
jj1<-summary(PCA1)
scores1$mass.rank<-trunc(rank(scores1$plant.mass..g))


PCplot1<-ggplot() +
  geom_point(data=scores1, aes(PC1, PC2, colour=Treatment, fill=Treatment, size=mass.rank*2), alpha=0.3) + 
  geom_segment(data = ecor1,aes(x = 0, y = 0, xend = PC1*15, yend = PC2*15), 
               arrow = arrow(angle=22.5,length = unit(0.35,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "black")+
  geom_text(data = ecor1,aes(PC1*15,PC2*15,label=row.names(ecor1)))+
  ggtitle("Time point 1")+
  labs(x=paste("PC 1 (", format(100 *jj1$importance[2,1], digits=4), "%)", sep=""),
       y=paste("PC 2 (", format(100 *jj1$importance[2,2], digits=4), "%)", sep=""))
PCplot1

adonis(subset(z4, Time.point %in% "T1")[,c(6:15)]~scores1$Treatment*scores1$plant.mass..g)
```


```{r, T2 PCA}
#TIME 2
scores2<-as.data.frame(PCA2$x[,c(1,2)])
scores2<-cbind(scores2,as.data.frame(subset(z4, Time.point %in% "T2"))[,c(1,4,5)] )
ecor2<-as.data.frame(PCA2$rotation[,c(1:2)])
jj2<-summary(PCA2)
scores2$mass.rank<-trunc(rank(scores2$plant.mass..g))

PCplot2<-ggplot() +
  geom_point(data=scores2, aes(PC1, PC2, colour=Treatment, fill=Treatment, size=mass.rank), alpha=0.3) + 
  geom_segment(data = ecor2,aes(x = 0, y = 0, xend = PC1*15, yend = PC2*15), 
               arrow = arrow(angle=22.5,length = unit(0.35,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "black")+
 geom_text(data = ecor2,aes(PC1*15,PC2*15,label=row.names(ecor2)))+
  ggtitle("Time point 2")+
  labs(x=paste("PC 1 (", format(100 *jj2$importance[2,1], digits=4), "%)", sep=""),
       y=paste("PC 2 (", format(100 *jj2$importance[2,2], digits=4), "%)", sep=""))
PCplot2

adonis(subset(z4, Time.point %in% "T2")[,c(6:15)]~scores2$Treatment*scores2$plant.mass..g)
```


```{r, T3 PCA}
#TIME 3
scores3<-as.data.frame(PCA3$x[,c(1,2)])
scores3<-cbind(scores3,as.data.frame(subset(z4, Time.point %in% "T3"))[,c(1,4,5)] )
ecor3<-as.data.frame(PCA3$rotation[,c(1:2)])
jj3<-summary(PCA3)
scores3$mass.rank<-trunc(rank(scores3$plant.mass..g))


PCplot3<-ggplot() +
  geom_point(data=scores3, aes(PC1, PC2, colour=Treatment, fill=Treatment, size=mass.rank), alpha=0.3) + 
  geom_segment(data = ecor3,aes(x = 0, y = 0, xend = PC1*15, yend = PC2*15), 
               arrow = arrow(angle=22.5,length = unit(0.35,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "black")+
  geom_text(data = ecor3,aes(PC1*15,PC2*15,label=row.names(ecor3)))+
  ggtitle("Time point 3")+
  labs(x=paste("PC 1 (", format(100 *jj3$importance[2,1], digits=4), "%)", sep=""),
       y=paste("PC 2 (", format(100 *jj3$importance[2,2], digits=4), "%)", sep=""))
PCplot3

adonis(subset(z4, Time.point %in% "T3")[,c(6:15)]~scores3$Treatment*scores3$plant.mass..g)
```


```{r, T4 PCA}
#TIME 4
scores4<-as.data.frame(PCA4$x[,c(1,2)])
scores4<-cbind(scores4,as.data.frame(subset(z4, Time.point %in% "T4"))[,c(1,4,5)] )
ecor4<-as.data.frame(PCA4$rotation[,c(1:2)])
jj4<-summary(PCA4)
scores4$mass.rank<-trunc(rank(scores4$plant.mass..g))


PCplot4<-ggplot() +
  geom_point(data=scores4, aes(PC1, PC2, colour=Treatment, fill=Treatment, size=mass.rank), alpha=0.3) + 
  geom_segment(data = ecor4,aes(x = 0, y = 0, xend = PC1*15, yend = PC2*15), 
               arrow = arrow(angle=22.5,length = unit(0.35,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "black")+
  geom_text(data = ecor4,aes(PC1*15,PC2*15,label=row.names(ecor4)))+
  ggtitle("Time point 4")+
  labs(x=paste("PC 1 (", format(100 *jj3$importance[2,1], digits=4), "%)", sep=""),
       y=paste("PC 2 (", format(100 *jj3$importance[2,2], digits=4), "%)", sep=""))
PCplot4

adonis(subset(z4, Time.point %in% "T4")[,c(6:15)]~scores4$Treatment*scores4$plant.mass..g)

```


```{r, PCA hell transform}
# With Hellinger transformations

zoop1<-decostand(subset(z4, Time.point %in% "T1")[,c(6:15)], "hell")
PCA1 <- prcomp(zoop1, center = TRUE)
zoop2<-decostand(subset(z4, Time.point %in% "T2")[,c(6:15)], "hell")
PCA2 <- prcomp(zoop2, center = TRUE)
zoop3<-decostand(subset(z4, Time.point %in% "T3")[,c(6:15)], "hell")
PCA3 <- prcomp(zoop3, center = TRUE)
zoop4<-decostand(subset(z4, Time.point %in% "T4")[,c(6:15)], "hell")
PCA4 <- prcomp(zoop4, center = TRUE)
```


```{r, T1 PCA hell transform}
#TIME 1
scores1<-as.data.frame(PCA1$x[,c(1,2)])
scores1<-cbind(scores1,as.data.frame(subset(z4, Time.point %in% "T1"))[,c(1,4,5)] )
jj1<-summary(PCA1)
ecor1<-as.data.frame(PCA1$rotation[,c(1:2)])
scores1$mass.rank<-trunc(rank(scores1$plant.mass..g))


PCplot1<-ggplot() +
  geom_point(data=scores1, aes(PC1, PC2, colour=Treatment, fill=Treatment, size=mass.rank*2), alpha=0.3) + 
  geom_segment(data = ecor1,aes(x = 0, y = 0, xend = PC1, yend = PC2), 
               arrow = arrow(angle=22.5,length = unit(0.35,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "black")+
  geom_text(data = ecor1,aes(PC1,PC2,label=row.names(ecor1)))+
  ggtitle("Time point 1")+
  labs(x=paste("PC 1 (", format(100 *jj1$importance[2,1], digits=4), "%)", sep=""),
       y=paste("PC 2 (", format(100 *jj1$importance[2,2], digits=4), "%)", sep=""))
PCplot1

apply(zoop1, 1, function(x) !all(x==0)) # Need to remove rows of all 0s for the permanova
adonis(zoop1[-5,]~scores1$Treatment[-5]*scores1$plant.mass..g[-5])

t1zoop<-dbrda(zoop1~scores1$Treatment*scores1$plant.mass..g) 
anova(t1zoop)
anova(t1zoop, by="terms", permu=800)



# Significant effect of plant mass
```


```{r, T2 PCA hell transform}
#TIME 2
scores2<-as.data.frame(PCA2$x[,c(1,2)])
scores2<-cbind(scores2,as.data.frame(subset(z4, Time.point %in% "T2"))[,c(1,4,5)] )
ecor2<-as.data.frame(PCA2$rotation[,c(1:2)])
jj2<-summary(PCA2)
scores2$mass.rank<-trunc(rank(scores2$plant.mass..g))

PCplot2<-ggplot() +
  geom_point(data=scores2, aes(PC1, PC2, colour=Treatment, fill=Treatment, size=mass.rank), alpha=0.3) + 
  geom_segment(data = ecor2,aes(x = 0, y = 0, xend = PC1, yend = PC2), 
               arrow = arrow(angle=22.5,length = unit(0.35,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "black")+
  geom_text(data = ecor2,aes(PC1,PC2,label=row.names(ecor2)))+
  ggtitle("Time point 2")+
  labs(x=paste("PC 1 (", format(100 *jj2$importance[2,1], digits=4), "%)", sep=""),
       y=paste("PC 2 (", format(100 *jj2$importance[2,2], digits=4), "%)", sep=""))
PCplot2

t2zoop<-dbrda(zoop2~scores2$Treatment*scores2$plant.mass..g) 
anova(t2zoop)
anova(t2zoop, by="terms", permu=800)
```


```{r, T3 PCA hell transform}
#TIME 3
scores3<-as.data.frame(PCA3$x[,c(1,2)])
scores3<-cbind(scores3,as.data.frame(subset(z4, Time.point %in% "T3"))[,c(1,4,5)] )
ecor3<-as.data.frame(PCA3$rotation[,c(1:2)])
jj3<-summary(PCA3)
scores3$mass.rank<-trunc(rank(scores3$plant.mass..g))


PCplot3<-ggplot() +
  geom_point(data=scores3, aes(PC1, PC2, colour=Treatment, fill=Treatment, size=mass.rank), alpha=0.3) + 
  geom_segment(data = ecor3,aes(x = 0, y = 0, xend = PC1, yend = PC2), 
               arrow = arrow(angle=22.5,length = unit(0.35,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "black")+
  geom_text(data = ecor3,aes(PC1,PC2,label=row.names(ecor3)))+
  ggtitle("Time point 3")+
  labs(x=paste("PC 1 (", format(100 *jj3$importance[2,1], digits=4), "%)", sep=""),
       y=paste("PC 2 (", format(100 *jj3$importance[2,2], digits=4), "%)", sep=""))
PCplot3

t3zoop<-dbrda(zoop3~scores3$Treatment*scores3$plant.mass..g) 
anova(t3zoop)
anova(t3zoop, by="terms", permu=800)

```


```{r, T4 PCA hell transform}
#TIME 4
scores4<-as.data.frame(PCA4$x[,c(1,2)])
scores4<-cbind(scores4,as.data.frame(subset(z4, Time.point %in% "T4"))[,c(1,4,5)] )
ecor4<-as.data.frame(PCA4$rotation[,c(1:2)])
jj4<-summary(PCA4)
scores4$mass.rank<-trunc(rank(scores4$plant.mass..g))


PCplot4<-ggplot() +
  geom_point(data=scores4, aes(PC1, PC2, colour=Treatment, fill=Treatment, size=mass.rank), alpha=0.3) + 
  geom_segment(data = ecor4,aes(x = 0, y = 0, xend = PC1, yend = PC2), 
               arrow = arrow(angle=22.5,length = unit(0.35,"cm"),
                             type = "closed"),linetype=1, size=0.6,colour = "black")+
  geom_text(data = ecor4,aes(PC1,PC2,label=row.names(ecor4)))+
  ggtitle("Time point 4")+
  labs(x=paste("PC 1 (", format(100 *jj3$importance[2,1], digits=4), "%)", sep=""),
       y=paste("PC 2 (", format(100 *jj3$importance[2,2], digits=4), "%)", sep=""))
PCplot4

t4zoop<-dbrda(zoop4~scores4$Treatment*scores4$plant.mass..g) 
anova(t4zoop)
anova(t4zoop, by="terms", permu=800)


```



### Greenhouse Gas Data
```{r}
rm(list=ls())

GHG<-read.csv("data/GH.gases/Pyro_ghg_d13C.csv")
GHG<-na.omit(GHG) # remove NAs

# set structure
make.fac<-c("Time.point", "Treatment", "Tank", "Gas")
GHG[make.fac] <- lapply(GHG[make.fac], factor) # make all these factors
GHG$plant.mass..g<-as.numeric(GHG$plant.mass..g)

# rename
GHG<- GHG %>% rename("GHG.nM" = "GHGwater..nmol.GHG..L.H2O")

# reorder columns and export
GHG<- GHG %>% select(Time.point, Treatment, plant.mass..g, Tank, Gas, GHG.nM, d13C)

GHG<-GHG[!(GHG$GHG.nM < 0),]
#############################################

```

### GHG isotopes
What does CO2-d13C look like?
```{r CO2 model plots}
############# GHG plots and models
#### CO2
#######-- T0

m1.T0.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T0", data = CO2,
            method="REML", family="gaussian")

m2.T0.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T0", data = CO2,
            method="REML", family="gaussian")

m3.T0.CO2.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T0", data = CO2,
            method="REML", family="gaussian")

CO2.d13C.T0.AIC<-AIC(m1.T0.CO2.d13C, m2.T0.CO2.d13C, m3.T0.CO2.d13C)
#factor and global smooth best

summary(m2.T0.CO2.d13C)
anova.gam(m2.T0.CO2.d13C)
gam.check(m2.T0.CO2.d13C, rep=1000)
draw(m2.T0.CO2.d13C)
concrvity(m2.T0.CO2.d13C)
par(mfrow = c(1, 2))
plot(m2.T0.CO2.d13C, all.terms = TRUE, page=1)

# model predictions
CO2.d13C.diff.T0<-plot_difference(
  m1.T0.CO2.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CO2.d13C.T0.mod.plot<-
  plot_smooths(
  model = m2.T0.CO2.d13C,
  series = plant.mass..g,
  comparison = Treatment
)  + theme(legend.position = "none") +
  geom_point(data=CO2[(CO2$Time.point=="T0"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CO2, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-0") +
  coord_cartesian(ylim=c(-30, 0)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CO2.d13C.T0.mod.plot

#### CO2 
#######-- T1

m1.T1.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T1", data = CO2,
            method="REML", family="gaussian")

m2.T1.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T1", data = CO2,
            method="REML", family="gaussian")

m3.T1.CO2.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T1", data = CO2,
            method="REML", family="gaussian")

CO2.d13C.T1.AIC<-AIC(m1.T1.CO2.d13C, m2.T1.CO2.d13C, m3.T1.CO2.d13C)
#global smooth best

summary(m3.T1.CO2.d13C)
anova.gam(m3.T1.CO2.d13C)
gam.check(m3.T1.CO2.d13C, rep=1000)
draw(m3.T1.CO2.d13C)
concrvity(m3.T1.CO2.d13C)
par(mfrow = c(1, 2))
plot(m3.T1.CO2.d13C, all.terms = TRUE, page=1)

# model predictions
CO2.d13C.diff.T1<-plot_difference(
  m1.T1.CO2.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CO2.d13C.T1.mod.plot<-
  plot_smooths(
  model = m3.T1.CO2.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CO2[(CO2$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CO2, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-1") +
  coord_cartesian(ylim=c(-30, 0)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CO2.d13C.T1.mod.plot

#### CO2
#######-- T2


m1.T2.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T2", data = CO2,
            method="REML", family="gaussian")

m2.T2.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T2", data = CO2,
            method="REML", family="gaussian")

m3.T2.CO2.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T2", data = CO2,
            method="REML", family="gaussian")

CO2.d13C.T2.AIC<-AIC(m1.T2.CO2.d13C, m2.T2.CO2.d13C, m3.T2.CO2.d13C)
#global smooth best

summary(m3.T2.CO2.d13C)
anova.gam(m3.T2.CO2.d13C)
gam.check(m3.T2.CO2.d13C, rep=1000)
draw(m3.T2.CO2.d13C)
concrvity(m3.T2.CO2.d13C)
par(mfrow = c(1, 2))
plot(m3.T2.CO2.d13C, all.terms = TRUE, page=1)

# model predictions
CO2.d13C.diff.T2<-plot_difference(
  m1.T2.CO2.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CO2.d13C.T2.mod.plot<-
  plot_smooths(
  model = m3.T2.CO2.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CO2[(CO2$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CO2, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-0") +
  coord_cartesian(ylim=c(-30,0)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CO2.d13C.T2.mod.plot


#### CO2 
#######-- T3

m1.T3.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T3", data = CO2,
            method="REML", family="gaussian")

m2.T3.CO2.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T3", data = CO2,
            method="REML", family="gaussian")

m3.T3.CO2.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T3", data = CO2,
            method="REML", family="gaussian")

CO2.d13C.T3.AIC<-AIC(m1.T3.CO2.d13C, m2.T3.CO2.d13C, m3.T3.CO2.d13C)
#factor smooth best

summary(m1.T3.CO2.d13C)
anova.gam(m1.T3.CO2.d13C)
gam.check(m1.T3.CO2.d13C, rep=1000)
draw(m1.T3.CO2.d13C)
concrvity(m1.T3.CO2.d13C)
par(mfrow = c(1, 2))
plot(m1.T3.CO2.d13C, all.terms = TRUE, page=1)

# model predictions
CO2.d13C.diff.T3<-plot_difference(
  m1.T3.CO2.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CO2.d13C.T3.mod.plot<-
  plot_smooths(
  model = m1.T3.CO2.d13C,
  series = plant.mass..g,
  comparison = Treatment
)  + theme(legend.position = "none") +
  geom_point(data=CO2[(CO2$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CO2, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-0") +
  coord_cartesian(ylim=c(-30, 0)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CO2.d13C.T3.mod.plot


# models and raw data
CO2.d13C.model.plots<-plot_grid(
  CO2.d13C.T0.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-0"),
  CO2.d13C.T1.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-10"),
  CO2.d13C.T2.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-31"),
  CO2.d13C.T3.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-59"),
  extract.legend, 
  rel_widths = c(8,8,8,8,3), ncol=5)

### model differences
CO2.d13C.plot.diff<-plot_grid(
  CO2.d13C.diff.T0+ ggtitle("CO2-T0"),
  CO2.d13C.diff.T1+ ggtitle("Day-10"),
  CO2.d13C.diff.T2+ ggtitle("Day-31"),
  CO2.d13C.diff.T3+ ggtitle("Day-59"),
  rel_widths = c(8,8,8,8), ncol=4)

## AIC table
mod.ghg.CO2.d13C<-rep(c("Treatment +s(plant.mass..g, by=Treatment)", 
              "Treatment + s(plant.mass..g)", 
              "s(plant.mass..g)"), times=4)

mod.ghg.d13C.df<- data.frame(mod.ghg.CO2.d13C)

AIC.CO2.d13C<-bind_rows(CO2.d13C.T0.AIC, CO2.d13C.T1.AIC, CO2.d13C.T2.AIC, CO2.d13C.T3.AIC)
AIC.CO2.d13C.mod<-cbind(mod.ghg.d13C.df, AIC.CO2.d13C)
write.csv(AIC.CO2.d13C.mod, "output/AIC models/AIC.CO2.d13C.mod.csv")

```

What does CH4-d13C look like?
```{r CH4 model plots}
############# GHG plots and models
#### CH4
#######-- T0

m1.T0.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T0", data = CH4,
            method="REML", family="gaussian")

m2.T0.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T0", data = CH4,
            method="REML", family="gaussian")

m3.T0.CH4.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T0", data = CH4,
            method="REML", family="gaussian")

CH4.d13C.T0.AIC<-AIC(m1.T0.CH4.d13C, m2.T0.CH4.d13C, m3.T0.CH4.d13C)
# global smooth best

summary(m3.T0.CH4.d13C)
anova.gam(m3.T0.CH4.d13C)
gam.check(m3.T0.CH4.d13C, rep=1000)
draw(m3.T0.CH4.d13C)
concrvity(m3.T0.CH4.d13C)
par(mfrow = c(1, 2))
plot(m3.T0.CH4.d13C, all.terms = TRUE, page=1)

# model predictions
CH4.d13C.diff.T0<-plot_difference(
  m1.T0.CH4.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CH4.d13C.T0.mod.plot<-
  plot_smooths(
  model = m3.T0.CH4.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CH4[(CH4$Time.point=="T0"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
 ylab(expression(paste(delta^{13}, CH4, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-0") +
  coord_cartesian(ylim=c(-50, -42)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CH4.d13C.T0.mod.plot

#### CH4 
#######-- T1

m1.T1.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T1", data = CH4,
            method="REML", family="gaussian")

m2.T1.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T1", data = CH4,
            method="REML", family="gaussian")

m3.T1.CH4.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T1", data = CH4,
            method="REML", family="gaussian")

CH4.d13C.T1.AIC<-AIC(m1.T1.CH4.d13C, m2.T1.CH4.d13C, m3.T1.CH4.d13C)
#global smooth best

summary(m3.T1.CH4.d13C)
anova.gam(m3.T1.CH4.d13C)
gam.check(m3.T1.CH4.d13C, rep=1000)
draw(m3.T1.CH4.d13C)
concrvity(m3.T1.CH4.d13C)
par(mfrow = c(1, 2))
plot(m3.T1.CH4.d13C, all.terms = TRUE, page=1)

# model predictions
CH4.d13C.diff.T1<-plot_difference(
  m1.T1.CH4.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CH4.d13C.T1.mod.plot<-
  plot_smooths(
  model = m3.T1.CH4.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CH4[(CH4$Time.point=="T1"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CH4, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-1") +
  coord_cartesian(ylim=c(-50, -42)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CH4.d13C.T1.mod.plot

#### CH4
#######-- T2


m1.T2.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T2", data = CH4,
            method="REML", family="gaussian")

m2.T2.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T2", data = CH4,
            method="REML", family="gaussian")

m3.T2.CH4.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T2", data = CH4,
            method="REML", family="gaussian")

CH4.d13C.T2.AIC<-AIC(m1.T2.CH4.d13C, m2.T2.CH4.d13C, m3.T2.CH4.d13C)
#global smooth best

summary(m3.T2.CH4.d13C)
anova.gam(m3.T2.CH4.d13C)
gam.check(m3.T2.CH4.d13C, rep=1000)
draw(m3.T2.CH4.d13C)
concrvity(m3.T2.CH4.d13C)
par(mfrow = c(1, 2))
plot(m3.T2.CH4.d13C, all.terms = TRUE, page=1)

# model predictions
CH4.d13C.diff.T2<-plot_difference(
  m1.T2.CH4.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CH4.d13C.T2.mod.plot<-
  plot_smooths(
  model = m3.T2.CH4.d13C,
  series = plant.mass..g,
)  + theme(legend.position = "none") +
  geom_point(data=CH4[(CH4$Time.point=="T2"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CH4, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-2") +
  coord_cartesian(ylim=c(-50, -42)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CH4.d13C.T2.mod.plot


#### CH4 
#######-- T3

m1.T3.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g, by=Treatment), subset = Time.point=="T3", data = CH4,
            method="REML", family="gaussian")

m2.T3.CH4.d13C<- gam(d13C ~ Treatment +
            s(plant.mass..g), subset = Time.point=="T3", data = CH4,
            method="REML", family="gaussian")

m3.T3.CH4.d13C<- gam(d13C ~
            s(plant.mass..g), subset = Time.point=="T3", data = CH4,
            method="REML", family="gaussian")

CH4.d13C.T3.AIC<-AIC(m1.T3.CH4.d13C, m2.T3.CH4.d13C, m3.T3.CH4.d13C)
#factor smooth best

summary(m1.T3.CH4.d13C)
anova.gam(m1.T3.CH4.d13C)
gam.check(m1.T3.CH4.d13C, rep=1000)
draw(m1.T3.CH4.d13C)
concrvity(m1.T3.CH4.d13C)
par(mfrow = c(1, 2))
plot(m1.T3.CH4.d13C, all.terms = TRUE, page=1)

# model predictions
CH4.d13C.diff.T3<-plot_difference(
  m1.T3.CH4.d13C,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
CH4.d13C.T3.mod.plot<-
  plot_smooths(
  model = m1.T3.CH4.d13C,
  series = plant.mass..g,
  comparison = Treatment
)  + theme(legend.position = "none") +
  geom_point(data=CH4[(CH4$Time.point=="T3"),], 
             aes(x=plant.mass..g, y=d13C, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  ylab(expression(paste(delta^{13}, CH4, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  ggtitle("Time-4") +
  coord_cartesian(ylim=c(-50, -42)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))

CH4.d13C.T3.mod.plot


# models and raw data
CH4.d13C.model.plots<-plot_grid(
  CH4.d13C.T0.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-0"),
  CH4.d13C.T1.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-10"),
  CH4.d13C.T2.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-31"),
  CH4.d13C.T3.mod.plot+ theme(legend.position= "none") + ggtitle( "Day-59"),
  extract.legend, 
  rel_widths = c(8,8,8,8,3), ncol=5)

### model differences
CH4.d13C.plot.diff<-plot_grid(
  CH4.d13C.diff.T0+ ggtitle("CH4-T0"),
  CH4.d13C.diff.T1+ ggtitle("Day-10"),
  CH4.d13C.diff.T2+ ggtitle("Day-31"),
  CH4.d13C.diff.T3+ ggtitle("Day-59"),
  rel_widths = c(8,8,8,8), ncol=4)

## AIC table
mod.ghg.CH4.d13C<-rep(c("Treatment +s(plant.mass..g, by=Treatment)", 
              "Treatment + s(plant.mass..g)", 
              "s(plant.mass..g)"), times=4)

mod.ghg.d13C.df<- data.frame(mod.ghg.CH4.d13C)

AIC.CH4.d13C<-bind_rows(CH4.d13C.T0.AIC, CH4.d13C.T1.AIC, CH4.d13C.T2.AIC, CH4.d13C.T3.AIC)
AIC.CH4.d13C.mod<-cbind(mod.ghg.d13C.df, AIC.CH4.d13C)
write.csv(AIC.CH4.d13C.mod, "output/AIC models/AIC.CH4.d13C.mod.csv")

```

Compile the greenhouse gas plots
```{r combine CO2CH4.d13C plots}

GHG.plots<-plot_grid(CO2.d13C.model.plots, CH4.d13C.model.plots, ncol=1)
ggsave("figures/GHG.isotope.mod.plots.pdf", height=7, width=12, encod="MacRoman")


GHG.plot.diff<-plot_grid(CO2.d13C.diff.T3, CH4.d13C.diff.T3, ncol=1)
ggsave("figures/GHG.isotope.mod.diff.pdf", height=7, width=4, encod="MacRoman")


```


###Chlorophyll  
import   
- may not be useful...
```{r chlorophyll, eval =FALSE}
## import treatment IDs
chl.dat<- read.csv("data/Pyro_chlorophyll.csv")  
chl.dat<-chl.dat[!(chl.dat$Time.point=="First.round"),] # remove first round from aborted mission

#remove outlier
chl.out.rem<-chl.dat[!(chl.dat$chla..ug.L>=10),]


#plot

chla.T0<-ggplot(chl.dat[(chl.dat$Time.point=="T0"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-0") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting


chla.T1<-ggplot(chl.dat[(chl.dat$Time.point=="T1"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-1") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T2<-ggplot(chl.dat[(chl.dat$Time.point=="T2"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-2") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T3<-ggplot(chl.dat[(chl.dat$Time.point=="T3"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-3") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T4<-ggplot(chl.dat[(chl.dat$Time.point=="T4"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-4") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting


chl.plots<-plot_grid(
  chla.T0+ theme(legend.position = "none"),
  chla.T2+ theme(legend.position = "none"),
  chla.T2+ theme(legend.position = "none"),
  chla.T3+ theme(legend.position = "none"),
  chla.T4+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,8,8,3), ncol=6)


chl.plots

ggsave("figures/chla.alltime.pdf", height=5, width=15)



```
  